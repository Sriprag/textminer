1660

IEEE JOURNAL OF BIOMEDICAL AND HEALTH INFORMATICS, VOL. 19, NO. 5, SEPTEMBER 2015

A Method for Context-Based Adaptive QRS
Clustering in Real Time
Daniel Castro, Paulo Félix, and Jesús Presedo

Abstract—Continuous followup of heart condition through longterm electrocardiogram monitoring is an invaluable tool for diagnosing some cardiac arrhythmias. In such context, providing
tools for fast locating alterations of normal conduction patterns is
mandatory and still remains an open issue. This paper presents
a real-time method for adaptive clustering QRS complexes from
multilead ECG signals that provides the set of QRS morphologies that appear during an ECG recording. The method processes
the QRS complexes sequentially by grouping them into a dynamic
set of clusters based on the information content of the temporal
context. The clusters are represented by templates which evolve
over time and adapt to the QRS morphology changes. Rules to
create, merge, and remove clusters are defined along with techniques for noise detection in order to avoid their proliferation. To
cope with beat misalignment, derivative dynamic time warping is
used. The proposed method has been validated against the MITBIH Arrhythmia Database and the AHA ECG Database showing
a global purity of 98.56% and 99.56%, respectively. Results show
that our proposal not only provides better results than previous
offline solutions but also fulfills real-time requirements.
Index Terms—Adaptive clustering, dominant points, dynamic
time warping (DTW), electrocardiogram (ECG), QRS clustering.

I. INTRODUCTION
OWADAYS, the surface electrocardiogram (ECG) is recognized as an invaluable tool for monitoring heart condition, since its analysis provides decisive information that can
reveal critical deviations from normal cardiac behavior. Recent
developments in mobile sensors and mobile computing have
enabled new scenarios for continuous ECG monitoring as an inexpensive tool for the early detection of some cardiac events [1],
especially in those cases where symptoms appear intermittently.
As the monitoring period increases, the interpretation task
becomes more time consuming and decision support tools are
needed to help cardiologists to reduce the time spent on it. If a
continuous followup is required, these tools become imperative.
Their main aim is to provide the cardiologists with a summary
of all the acquired signals, enhanced with a fast locating of those
anomalies detected.

N

Manuscript received February 17, 2014; revised July 4, 2014 and September
1, 2014; accepted September 26, 2014. Date of publication October 8, 2014; date
of current version September 1, 2015. This work was supported by the Spanish
Ministry of Science and Innovation under Grant TIN2009-14372-C03-03.
The authors are with the Centro de Investigación en Tecnoloxı́as da Información, University of Santiago de Compostela, 15782 Santiago de Compostela,
Spain (e-mail: daniel.castro@usc.es; paulo.felix@usc.es; jesus.presedo@
usc.es).
Color versions of one or more of the figures in this paper are available online
at http://ieeexplore.ieee.org.
Digital Object Identifier 10.1109/JBHI.2014.2361659

Cardiac arrhythmias are the most relevant among the ECG
findings. There are two main sources of arrhythmias: An
automatism disorder, that is, a set of alterations in the beat activation point due to changes in its location or activation frequency;
or a conduction disorder, that is, an abnormal propagation of the
beat wavefront through the cardiac tissue. They both have an
effect on the ECG, affecting the beat morphology and/or beat
rhythm. In order to support their identification, a method for
separating the beats by their activation point and conduction
pattern should be provided.
Beat classification arises as the task of assigning each beat
in an ECG a label identifying its physiological nature. Machine
learning techniques have been applied to this task by estimating
the underlying mechanisms that produce the data of a training
set. The main drawback of this approach is its strong dependence
on the pattern diversity present in the training set. Thus, interpatient differences show that it cannot be assumed that a classifier
trained on data of a large set of patients will yield valid results on
a new patient [2]–[4], and intrapatient differences show that this
cannot be assumed even for the same patient throughout time.
In addition, class labels only provide gross information about
the origin of the beats in the cardiac tissue, losing all the information about their conduction pathways. This approach does
not distinguish the multiple morphological families present in a
given class, as occurs in multifocal arrhythmias.
In contrast, beat clustering aims at dividing the ECG recording
in a set of beat clusters, each one of them preserving some
similar properties. Previous proposals have focused on an offline
approach from a priori maximum number of clusters [5]–[8] and
they imply processing the ECG signal once the acquisition has
been completed. This approach has given good noise robustness
but as a side effect, a single morphology is usually replicated in
several clusters and rare beat morphologies can be missed. It also
omits the dynamic aspect of ECG and, in particular, ignores the
temporal evolution of morphologies. Furthermore, the detection
of critical events can be deferred too long to provide timely
attention. For all these reasons, a dynamic online approach must
be considered.
In this paper, we present a real-time method for adaptive
beat clustering, with a potential application not only as a previous step for classification [9], but also as a summary about
those beat morphologies present in a certain period, their temporal evolution and variability, or even to detect the presence
of alternating morphologies. The proposed method emulates
the experts behavior in exploiting the temporal context for
assigning each new beat to the most appropriate cluster. To
this end, clusters are continuously adapting to the temporal
evolution of beat morphologies, and they can be dynamically

2168-2194 © 2014 IEEE. Personal use is permitted, but republication/redistribution requires IEEE permission.
See http://www.ieee.org/publications standards/publications/rights/index.html for more information.

CASTRO et al.: METHOD FOR CONTEXT-BASED ADAPTIVE QRS CLUSTERING IN REAL TIME

1661

Fig. 1. Flowchart of the method proposed for QRS clustering. The different stages involved in beat processing are shown and the creation of a new cluster is
exemplified. Each block refers to the corresponding section.

created, merged or modified, resulting in a variable number of
clusters.
Beat clustering requires extracting from the ECG a set of representative measurements for every beat. Bibliography shows a
variety of proposals for beat representation that can be grouped
into four categories: morphological features where the signal
amplitude is directly used [2], [4], [7], [9]; segmentation features like area, amplitude, or interval duration from beat waves
[2], [4], [7], [10] or amplitude and angle values from vectorcardiogram [3]; statistical features derived using high-order cumulants [4], [11], [12]; and finally, transformed space features,
defined in an alternative space using different transforms like
Karhunen–Loewe transform [13], Hermite basis functions [4],
[5], [12], discrete Fourier transform [9], [14] or wavelet transform [3], [14]. All the previous works complete their feature
sets with rhythm information to complement their description
capabilities.
This paper proposes a new approach to represent a beat by
reducing the QRS complex to a set of relevant points and support regions. This representation has some nice properties for
beat clustering: It is stable against the usual variability and the
presence of noise in the ECG, and it explicitly represents the
temporal location of some QRS features.
The proposed method processes a real-time multilead ECG
signal through a set of data-driven stages as shown in Fig. 1. In
order to obtain comparable results, signals from two standard
ECG signal databases are used as data source (see Section II).
The preprocessing stage comprises real-time beat detection and
baseline filtering (see Section III). Then, a fixed-length signal
segment is selected for extracting and characterizing the QRS
complex (see Section IV-A). QRS complexes are compared to
the current set of clusters following a context-based criteria to
obtain the best matching cluster (see Sections IV-B–D). After-

wards, the current cluster set is updated in one of three ways:
Creating a new cluster, modifying the most similar one or merging two or more clusters (see Section IV-E). The next stage
performs a noise analysis for each lead in order to detect noisy
intervals and avoid the processing of noisy beats or discard the
clusters created from them (see Section V). Finally, the beats are
classified by their rhythm type and a set of groups with common
morphology and rhythm is obtained (see Section VI).
The ECG databases have been processed and their beat
class labels have been used to validate the purity of the final cluster and group sets (see Section VII). These results are
discussed in Section VIII along with the conclusions of this
paper.
II. ECG SIGNAL DATABASES
The ECG databases recommended by the ANSI/AAMI EC57
[15] standard for reporting the performance of arrhythmia detectors were used for validation purposes: The MIT-BIH Arrhythmia database and the AHA ECG database.
The MIT-BIH Arrhythmia database [16], [17] can be referred
to as the golden standard for beat clustering and classification
tasks and it is the reference database for almost all the literature in this field. This database is composed of 48 recordings
of ambulatory ECG, obtained from 47 different patients which
comprise a very complete set of examples of common and rare
arrhythmias. Each record has a duration of 30 min, and includes two channels with the same leads in almost all of them:
a modified-lead II (MLII) in the first one and lead V1 in the
second one. MLII was replaced by lead V5 in three records and
V1 was replaced by MLII, V2, V4 or V5 on eight records. The
signals were digitized at fs = 360 Hz and bandpass filtered with
cutoff frequencies at 0.1 and 100 Hz. All beats present in the

1662

IEEE JOURNAL OF BIOMEDICAL AND HEALTH INFORMATICS, VOL. 19, NO. 5, SEPTEMBER 2015

database were annotated by at least two expert cardiologists and
assigned a class label using a 16 label set.
The AHA ECG database was compiled by the American Heart
Association and it is composed of 155 recordings of ambulatory
ECG digitized at fs = 250 Hz containing the most relevant types
of ventricular arrhythmias. Each record is 3 h long with two
channels but only the last 30 min have been manually annotated
by experts.
III. PREPROCESSING
The major drawback of processing long-term ECG signals is the presence of a high level of noise with multiple
manifestations—baseline wandering, power line interference or
electromyographic activity— so an initial filtering stage needs
to be performed. The efforts have been focused on filtering the
baseline wandering as this is the most relevant source affecting the reliability of the clustering algorithm because of the
distortion it can cause on the QRS morphology.
A. Baseline Filtering
The baseline filtering is performed through the estimation of
the baseline wandering and its posterior elimination from the
original ECG. To achieve this goal, each signal is processed by
two sequentially connected median filters of 200 and 600 ms,
respectively, as described in [2]. A global delay of 400 ms is
added by this process, independently of the sampling rate.
B. Beat Detection
In order to carry out an evaluation of the clustering method
separately from beat detector and provide a fair comparison
framework for future algorithms, we used the beat position provided by the ECG databases as fiducial points.
A beat detector is required for real scenarios affecting the
quality of results. However, it virtually does not increment the
global computational complexity as QRS detection represents
only a small fraction of it. The global delay would not be affected
either since the beat detection can be performed concurrently
with baseline filtering with a shorter delay.
IV. CLUSTERING
In this paper, the following notation is used. Bold face variables (e.g., x) to represent vectors and sequences, lower case
alphabets with subscripts to represent their components (e.g.,
xi ) or superscripts when a temporal index is used as a subscript
(e.g., xin ), upper case alphabets (e.g., X) to represent sets, and
calligraphic letters to represent functions (e.g., F).
The aim of the clustering method is to group those beats in
real time, which share the same activation area and propagation
pattern in the cardiac tissue. The propagation of the electrical
impulse through the heart is reflected in the ECG as a sequence
of waves corresponding to the activity in the atria and ventricles. P wave and QRS complex are of particular interest since
they show the atria and ventricular depolarization, respectively,
thereby providing a fingerprint of the conduction pathway.
Since the noise level of ambulatory signals makes the detection of the P wave a very difficult task, we focus on the QRS

Fig. 2. Example of a subsequence qln for lead l = 2, of a beat at sample 4102,
n = 13, from record 108 of the MIT-BIH database. The relevant points detected
by the algorithm are marked with *. The parameters involved in the relevant
point detection are also shown.

morphology to characterize the beat. As a consequence, beats
with different atrial activation points or even with nodal activation points can share the same QRS morphology and will be
assigned to the same cluster. In the absence of a P wave analysis,
rhythm information can be useful in some cases to detect this
situation, as explained in Section VI.
The proposed method is intended to provide a real-time resume of the ECG signal as a dynamic set of clusters. Whenever a new beat is detected, the set of clusters is updated.
Let C denote a time series C = {C1 , C2 , . . . , Cn , . . .} where
Cn = {Cnc | 1 ≤ c ≤ Nn } is the set of clusters that represents
those QRS morphologies which appeared from the beginning of
the recording up to the beat n, Cnc is the set of beats assigned to
cluster c, and Nn the number of clusters, both at beat n.
The clustering follows a data-driven flow triggered by the beat
detector as shown in Fig. 1. Each new beat is compared to the
set of clusters Cn using concordance and dissimilarity measures
in order to find the best matching and giving preference to those
in its temporal context. A detailed explanation of this process
follows in the remaining sections: First, a beat characterization
and a template-based representation of the clusters; next, the
alignment technique and the measures used to compare beats
and clusters; afterwards, the criteria for cluster selection and,
finally, the process of updating the set of clusters.
A. QRS Characterization
We adopt a strategy inspired by dominant point detection [18]
to characterize the QRS morphology through its constituent
waves. Let S = {st | st ∈ RL ∧ t ∈ N} denote a time series
which represents the multilead ECG signal, where L is the
number of leads and st = (s1t , . . . , sLt ) is the vector of samples
at time t for all leads. When the nth beat is detected with fiducial
mark at time t, a fixed-length subsequence of w = w− + w+
samples (w− before and w+ − 1 after t) is selected from each
lead l to represent its QRS complex (see Fig. 2)
q ln = {q1l , . . . , qjl , . . . , qwl }

(1)

CASTRO et al.: METHOD FOR CONTEXT-BASED ADAPTIVE QRS CLUSTERING IN REAL TIME

where qjl = slt−w − −1+j . We set w− = 0.1 × fs  and w+ =
0.2 × fs , which are wide enough to capture the longest QRS
of abnormal beats [19] (V, F, and f beat types, typically).
Most of this section describes operations over one lead; thus,
for the sake of notation simplicity, the l superscript will be
obviated unless multiple leads are involved.
We define the curvature K at qj ∈ q n as
K(qj , q n ) =

max

i∈I j− ,k ∈I j+

cos q
i qj qk

(2)

where 2 ≤ j ≤ w − 1. The terms Ij− and Ij+ denote the intervals
used for calculating the curvature and they are given by
Ij− = {i | (j − θ) ≤ i < j ∧
∀a ∈ (i, j), ( max Δqj,b − Δqj,a ) < ρm in }
b∈(a,j )

(3)

Ij+ = {k | j < k ≤ (j + θ) ∧
∀a ∈ (j, k), ( max Δqj,b − Δqj,a ) < ρm in }
b∈(j,a)

(4)

where Δqj,x = |qj − qx |. The term θ is the maximum physiologically meaningful width of a QRS wave between its peak
location and its left or right end so that it is the upper limit of Ij−
and Ij+ . The term ρm in is the minimum height for a signal deflection to be considered physiologically relevant and, therefore,
to be excluded from the calculation of curvature.
We define the dominance region of a sample qj as
dominance (qj ) = [r− , r+ ]

(5)

−

+
where r = min(arg maxi∈I j− cos q
i qj qk ) for any fixed k ∈ Ij

−
and r+ = max(arg maxk ∈I + cos q
i qj qk ) for any fixed i ∈ Ij .
j
We define the set of dominant points of q n as

Dn = {pj | pj = qj ∧ j
=

arg max
a ∈ dom inance(q j )

K(qa , q n ) ∧ Δqj > ρm in }

(6)

Bn =< q n , Pn > .

(11)

There is not a consensus in the literature about the limits for
width and height of QRS complex or individual QRS waves.
The AAMI standard [20] recommends a minimum amplitude of
50 μV and the duration of 10 ms for a QRS wave to be detected,
and 150 μV for peak-to-peak QRS amplitude with a minimum
duration of 70 ms. On the other hand, the AHA [21] and CSE
[19] report lower amplitude for QRS waves (down to 20 μV and
10 ms) based on measures over averaged beats with increased
signal-to-noise ratio. These limits were not established for physiological reasons but for signal noise level or instrumentation
limitations. Nothing is stated about maximum QRS width beyond a reference to case-based duration values (e.g. the CSE
study [19] reports a maximum QRS width of 210 ms). In our
case, due to the signal-to-noise ratio present in the ambulatory
signals, the value of ρQRS is set to 150 μV in order to avoid the
detection of small waves caused by noise and the value of θ is
set to 100 ms to accept QRS waves with a maximum width of
200 ms. The value of ρm in is set to 50 μV following the AAMI
standard [20] and will be useful to detect noise contaminated
QRS complexes.
In order to perform the comparison between a new beat Bn
and the current set of clusters Cn −1 , each cluster Cnc −1 is represented by a template
(12)

where q cn −1 = {q1c , . . . , qwc } is derived from the QRS of the
beats assigned to Cnc −1 as will be explained in Section IV-E.
B. QRS Temporal Alignment

(7)

where ρQRS is the minimum height for a signal deflection to be
considered a relevant QRS wave with ρQRS > ρm in . If Rn = ,
then it is redefined as Rn = {arg maxp j ∈D n Δqj }.
The limits of dominance (qj ) can be located at any point in
the edge of a wave. Since we are interested in capturing its full
extent, the support region of a relevant point pj ∈ Rn is defined
as
support(pj ) = [j − , j + ]

In consequence, adjacent support regions can now overlap.
A relevant point pj is said to be in a concave wave if qj > qj −
and qj > qj + . Otherwise, it is said to be in a convex wave. The
wave height is defined as Δpj = min(Δqj,j − , Δqj,j + ).
Finally, the nth beat is represented by the QRS signal segment
and the set of its relevant points and support regions Pn =
{(pj , support(pj )) | pj ∈ Rn } and denoted by

Tnc −1 = < q cn −1 , Pnc −1 >

where Δqj = min(Δqj,r − , Δqj,r + ).
We define the set of relevant points of q n as
Rn = {pj | pj ∈ Dn ∧ Δqj > ρQRS }

1663

(8)

where j − ≤ r− and j + ≥ r+ are the sample numbers nearest to
r− and r+ where slope sign changes
j − = min− ({i | i ≤ r− ∧ ∀a ∈ [i, r− ], Δqj,a > Δqj,a+1 }) (9)
i∈I j

j + = max
({k | k ≥ r+ ∧ ∀a ∈ [r+ , k], Δqj,a < Δqj,a+1 }).
+
k ∈I j

(10)

In order to compare a beat Bn with a cluster template Tnc −1 , a
temporal alignment of q n and q cn −1 is performed using dynamic
time warping (DTW) [22]. The aim of this alignment process
is twofold. First, to correct any temporal misalignment due to a
misplaced fiducial mark and second, to reduce the contribution
of the height and width variability of the QRS waves to the
dissimilarity measure.
DTW was previously used for this purpose in [6], providing a relation m = (m1 , . . . , mK ) between q n and q cn −1 called
warping path, with mk = (xk , yk ) ∈ [1, w] × [1, w], k ∈ [1, K]
and K ≥ w. Each mk represents the alignment of the index xk
of q n with the index yk of q cn −1 under three conditions: First,
m1 = (1, 1) and mK = (w, w); second, xi ≤ xk and yi ≤ yk
∀i < k; and third, mk +1 − mk ∈ {(1, 1), (1, 0), (0, 1)}. These
conditions preserve the time-ordering of points and prevent
some point being missed in the alignment.
Let G denote the
cost function associated to a warping path dec
fined by G(m) = K
k =1 Gl (xk , yk ), where Gl (x, y) = |qx − qy |

1664

IEEE JOURNAL OF BIOMEDICAL AND HEALTH INFORMATICS, VOL. 19, NO. 5, SEPTEMBER 2015

is the local cost function associated with each element of m.
The optimal warping path is the one that minimizes G.
DTW aligns the original signal samples, so any component
k from m where mk +1 − mk ∈ {(1, 0), (0, 1)} introduces a
horizontal segment into the aligned signals. Since this can lead
to unacceptable distortion of the QRS, we adopt the derivative
dynamic time warping (DDTW) [23], which uses the estimation of the derivative instead of the signal itself. The derivative
is approximated by the first difference q̇ n = (q̇1 , . . . , q̇w −1 )
and q̇ cn −1 = (q̇1c , . . . , q̇wc −1 ) with q̇x = qx+1 − qx and q̇yc =
qyc +1 − qyc .
We imposed some additional conditions on the selected warping path so as to restrict the alterations of aligned signals.
A global restriction is set in the search process by defining a
warping window δ (named Sakoe-Chiba band [22]) to limit the
temporal distance between aligned samples so |xk − yk | < δ.
We set δ = 5, which corresponds to a distance of 14 ms with
fs = 360 Hz, and is long enough to deal with small misalignments of beat marks. A local restriction is also used to limit
the number of times the same sample can be aligned, setting a
/ {(0, a), (a, 0)} ∀a > λ. We
slope constraint: mk +a − mk ∈
set λ = 2 to limit the variation in the amplitude of the aligned
signals. Both conditions together allows the DDTW to cancel
out wave differences up to three times in amplitude and up to δ
samples in width.
Finally, after the optimal warping path m is found, the aligned
cn −1 are obtained with coordinates qk +1 = qk +
n and q
signals q
q̇x k and qkc +1 = qkc + q̇yc k for k ∈ [1, K], where q1 = q1 and
q1c = q1c . Fig. 3 shows the result of the alignment of the current
QRS complex and a template.

Fig. 3. Example of the DDTW alignment process. For each figure, the upper
solid and dashed lines represent the beat and template data, respectively; bottom
solid lines represent their absolute difference. (a) Shows qn and qcn −1 subsequences; (b) q̇n and q̇cn −1 derivative approximations; (c) optimally aligned
c
qn and 
qn −1 of length
derivatives of length K ≥ w − 1; (d) subsequences 
K + 1 obtained from the optimally aligned derivatives. In (b) and (c), the difference is equivalent to the local cost function Gl (x, y) = |q̇x − q̇yc |. Notice the
temporal increment K − w in (c) and (d) as a result of the process. The absolute
difference may also be increased in (d) outside the support regions but this is
irrelevant.

C. Template Matching
In order to assign a beat Bn to an existent cluster Cnc −1 , we
design a similarity calculation that only considers the difference between signals over the support region of each relevant
point; thus, limiting the comparison to the constituent waves
of the QRS. Given a pair (pj , [j − , j + ]) ∈ Pn , we are interested
in verifying whether Tnc −1 contains a similar wave in the same
location of the QRS. In order to do so, the interval [ǰ − , ǰ + ]
of q cn −1 aligned with the interval [j − , j + ] of q n must be obtained (see Fig. 4). To this end, the warping path m is used
n obtaining the equivto map j and [j − , j + ] from q n into q

j + ] for its supalent index j for the relevant point, and [
j−, 
−


port region where j = max{k | xk = j}, j = min{k | xk =
j + = max{k | xk = j + }, being (xk , yk ) ∈ m. Afterj − }, and 
n are already aligned by the application
cn −1 and q
wards, since q
cn −1 is selected and
j + ] from q
of DDTW, the same interval [
j−, 
c
mapped into q n −1 using the warping path. The interval [ǰ − , ǰ + ]
is given by ǰ − = yj − and ǰ + = yj + .
Once the aligned intervals are obtained, we proceed to
evaluate the concordance of both vectors. The segment
q cn −1 is said to concord with q n at pj and denoted by
q cn −1 ≈p j q n if q cn −1 contains a deflection in [ǰ − , ǰ + ] with
height Δpcǰ > ρm in likely to be considered a significant
c
c
|, |qpc eak − q+
|) being
waveform where Δpcǰ = min(|qpc eak − q−

Fig. 4. Parameters involved in calculating the concordance and local dissimilarity of a cluster with respect to a beat at a relevant point p j . Solid and dashed
lines represent beat and template data, respectively. (a) Shows parameters involved in concordance checking; the support region [j − , j + ] and the derived
intervals [
j−,
j + ] and [ǰ − , ǰ + ] are drawn; (b) signal segments within the interj −, 
j +] with a vertical alignment performed in the subintervals [
j−,
j ] and
val [
+
−
+
[
j,
j ] independently; ΔA j and ΔA j areas are shaded; (c) the same signal

+
segments shown in (b) with A −
j and A j areas shaded.

CASTRO et al.: METHOD FOR CONTEXT-BASED ADAPTIVE QRS CLUSTERING IN REAL TIME

c
c
peak = arg mini∈[ ǰ − , ǰ + ] qic , q−
= maxi∈[ ǰ − ,p eak] qic and q+
=
c
maxi∈[p eak,j + ] qi for pj in a convex wave [see Fig. 4(a)]. Otherwise, min and max functions are interchanged.
We define the concordance ratio of q cn −1 with respect to q n
at pj , denoted by Cp j (q cn −1 , q n ), as

Cp j (q cn −1 , q n ) =

min(Δpj , Δpcǰ )
max(Δpj , Δpcǰ )

(13)

if q cn −1 ≈p j q n . Otherwise, Cp j (q cn −1 , q n ) = 0.
We define the local dissimilarity of q cn −1 with respect to q n at
pj , and denoted by Dp j (q cn −1 , q n ), as a weighted relative area
cn −1 and q
n at the interval [
difference between q
j−, 
j+ ]


2
2
(ΔA−
(ΔA+
1
j )
j )
c
+
.
× −
Dp j (q n −1 , q n ) =
+
A−
A
A
+
A+
j
j
j
j
(14)
+
and
ΔA
represent
the
areas
under
a
=
The terms ΔA−
j
j
c
−
+




n −1 | over the intervals [j , j] and [j, j ], respectively,
|
qn − q
[see Fig. 4(b)]. Computing the area at each side of 
j independently allows us to minimize the effect of vertical misalignment
or amplitude variation on each interval by subtracting their own
median. Using the trapezoidal rule

1
ak + (aj − + aj ) − (
j −
j − )M − (15)
ΔA−
j =
2
−
k ∈(j ,j )



ΔA+
j =

k ∈(j ,j + )

1
ak + (aj + aj + ) − (
j+ − 
j)M + (16)
2

−

where M = mediank ∈[j − ,j ] ak and M
A−
j

A+
j

+

= mediank ∈[j ,j + ] ak .
represent the areas below [
j−, 
j] and

and
The terms
+


n , respectively [see Fig. 4(c)]. They are
[j, j ] intervals of q
estimated using the trapezoidal rule







1
− −



A−
(
q
=
q

+
+
q

)
−
(
j
−
j
)
q
k
j −
j
j

 (17)
2


−
k ∈(j ,j )



 



1
+
+



A+
(
q
=
q

+
+
q

)
−
(
j
−
j)
q
k
j
j +
j

 (18)
2
k ∈(j ,j + )

where q− = maxk ∈[j − ,j ] qk and q+ = maxk ∈[j ,j + ] qk for pj in
a convex wave. Otherwise, max is replaced by min.
We define the piecewise similarity of q cn −1 with respect to
q n , denoted PS(q cn −1 , q n ), as the sum of two bounded contributions from the set of concordant and nonconcordant relevant
points

Cp j (q cn −1 , q n ) . sig(Dp j (q cn −1 , q n ))
PS(q cn −1 , q n ) =
p j ∈R n

−

max

p j |q cn −1 ≈p j q n

Dp j (q cn −1 , q n )

(19)


where the sigmoid function sig(x) = 1 − αx/ 1 + (αx)2
keeps the contribution of each point in the interval [0, 1]. The
parameter α determines the decrease rate of the contribution

1665

as the local dissimilarity increases and, as a consequence, the
weight of a high dissimilarity value in the final piecewise dissimilarity. We limit the contributions of those points out of a range
of admissible local dissimilarity. In order to set such range, we
consider the effect of amplitude and temporal variability of QRS
waves. A temporal misalignment of one signal sample between
the QRS waves of qn and qnc −1 can lead to local dissimilarities of
around 20%. Then, we set an interval of [0, 25%] with a slightly
greater upper bound and α = 4 so the maximum contribution
out of this interval is 0.30.
The previous measure is asymmetric since it depends on the
relevant points and areas of one signal, so we define the similarity between Bn and Tnc −1 as
S(q n , q cn −1 ) = PS(q cn −1 , q n ) + PS(q n , q cn −1 )

(20)

thus, obtaining a value which captures the concordance, similarity, and morphological complexity of both signal segments.
This measure allows us to select the most similar template
within a set but we need a reference scale to evaluate the degree
of matching. To this end, we define the normalized piecewise
similarity as
PS(q cn −1 , q n ) = PS(q cn −1 , q n )/|Rn |

(21)

and the normalized similarity as
S̄(q n , q cn −1 ) = S(q n , q cn −1 )/(|Rn | + |Rnc −1 |)

(22)

where Rnc −1 is the set of relevant points of q cn −1 .
D. Cluster Selection
The occurrence of different QRS morphologies in a segment of ECG signal is usually limited by a reduced set of
activation points and conduction pathways. Thereby, we expect that the majority of QRS complexes in an ECG recording share their morphology with some of the QRS complexes
present in a short previous temporal interval. For that reason, the search for the cluster Cnwin
−1 ∈ Cn −1 that best matches
a beat Bn is first performed in the set of clusters present
in its temporal context Cnctx
−1 ⊂ Cn −1 (see Fig. 5). We define the temporal context as the set of τ beats previous to
c
Bn , τ –ctx− (Bn ) = {Bn −i | 1 ≤ i ≤ τ } and Cnctx
−1 = {Cn −1 ∈
−
c
Cn −1 | ∃Bi ∈ τ –ctx (Bn ) ∧ Bi ∈ Cn −1 }. The context length
is set to τ = 15 beats, the number of beats displayed in the
typical 10 s ECG strip used by cardiologists for a heart rate of
80 beats/min. This context is long enough to include every QRS
morphology present in multifocal arrhythmias. Throughout this
section, the l superscript is used to denote the lead.
The similarity measure is used to identify the most similar template for each lead as siml = arg maxc S(q ln , q c,l
n −1 ) and
then the best matching cluster is obtained by majority vote as
sim = mode{siml | l ∈ [1, L]}. If multiple clusters are selected,
a second vote is performed to obtain a single one using the normalized similarity.
sim ,,l
l
Beat Bn is assigned to Cnsim
−1 if the condition S̄(q n , q n −1 ) >
win
sim
γ is fulfilled in all leads. Then Cn −1 = Cn −1 . We set a value of
γ = 0.30, which corresponds to the maximum contribution of a
point with local dissimilarity outside the admissible interval.

1666

Fig. 5.

IEEE JOURNAL OF BIOMEDICAL AND HEALTH INFORMATICS, VOL. 19, NO. 5, SEPTEMBER 2015

Flowchart of the cluster selection and cluster set updating processes.

When Bn and Cnsim
−1 are not similar enough, a new comparison
is performed within the subset Cn −1 − Cnctx
−1 , obtaining the most
∗
sim ∗
.
If
B
and
C
are
similar enough, the
similar cluster Cnsim
n
−1
n −1
sim ∗
=
C
.
Otherwise,
the beat is not
beat is assigned and Cnwin
−1
n −1
assigned to any existing cluster and its most similar cluster
sim
sim ∗
Cnwin
−1 is selected between Cn −1 and Cn −1 using the same voting
criteria previously seen.
E. Cluster Set Updating
In order to adaptively respond to the changing behavior of
the ECG, clusters must be dynamically created, modified, or
merged whenever a new beat is detected.
1) Cluster Creation: If Bn is not assigned to Cnwin
−1 , a new
cluster Cnnew is created and its template is initialized for each
lead using the beat representation: Tnnew ,l = Bnl . Then the cluster set is updated as Cn = Cn −1 ∪ {Cnnew }.
2) Cluster Modification: If Bn is assigned to Cnwin
−1 , then the
∪
{B
}
and
the
template
cluster is updated to Cnwin = Cnwin
n
−1
win,l
win,l
win,l
win,l
Tn −1 = < q n −1 , Pn −1 > is modified to Tn
for each lead.
To this end, q nwin,l is calculated from q ln and q win,l
n −1
win,l
l
q̇ywin.l
,n = (1 − β)q̇y ,n −1 + β mean({q̇x,n | (x, y) ∈ m})

(23)
qywin,l
,n =
win,l
q1,n

qywin,l
−1,n

+ q̇ywin,l
,n

win,l
q1,n
−1 .

(24)

where
=
The term β is the coefficient of the
exponential update. Setting a value for β implies a tradeoff
between plasticity and stability of the cluster template. We set
β = 1/8 so the last 16 beats assigned to the cluster provide

90% of the contributions to the current template. This allows
the template to be adapted to the evolution of the QRS morphology. Afterwards, the set of relevant points and support regions
and assigned to the template:
Pnwin,l is obtained from q win,l
n
, Pnwin,l >.
Tnwin,l = < q win,l
n
3) Cluster Merging: During the clustering process, different
clusters can evolve to represent the same QRS morphology so
they should be merged. This situation is common when QRS
complexes suffer from transient distortions in their morphology
due to intrinsic variability, which makes them fall below the
similarity threshold for their proper clusters. In this case, a new
cluster is created which is subjected to an initial transient period
during which the template for each lead can evolve getting closer
to its most similar cluster.
In order to detect this situation, we define a relation closest
which links each cluster with its most similar one among previous clusters. The relation is set for each new cluster as
Cnwin = closest(Cnnew ). As templates evolve with new assigned
QRS complexes, the relation could have to be updated.
win
When Bn is assigned to Cnwin
−1 , the cluster is updated to Cn
and its most similar cluster may change. The closest relation is
updated when multiple clusters in the same set than Cnwin
−1 , be it
ctx
or
C
−
C
,
fulfill
the
assignment
condition
either Cnctx
n −1
−1
n −1
S̄(q ln , q c,l
)
>
γ
in
all
leads
(see Section IV-D). Since Cn has
n −1
been updated, getting more similar to Bn , the best matching
cluster Cns −1 for Bn is selected within the remaining subset of
L
c,l
l
clusters, where s = arg maxC nc −1 = C nw −1
in (
l=1 S(q n , q n −1 )/L)
s
and the oldest of both clusters, Cnwin
−1 or Cn −1 , is set as the
new most similar cluster for the other. Then, the clusters Cnwin
and Cns are checked for possibly merging, since their templates
have evolved to be similar enough to the last beat (see Fig. 5).
The condition for merging those clusters will be analogous to
win,l
) > γ  , where
the condition for beat assignment: S̄(q s,l
n , qn

γ = 0.40, which corresponds to the maximum contribution of
a point with local dissimilarity over 20%. The threshold value
is increased with respect to γ since both signal segments are
promediated templates with increased signal-to-noise ratio.
Afterwards, the special case of clusters within its transient
period is considered. We establish the duration of this transitory
state in terms of the number of assigned beats. Hence, if Bn
win
is assigned to Cnwin
−1 and |Cn | < μ, the cluster is checked for
merging with its closest one Cns = closest (Cnwin ) (see Fig. 5).
We set μ as the minimum number of beats assigned to the
cluster to confirm, it represents an independent morphology and
we consider μ = 10 enough for this purpose.
When two clusters Cnwin and Cnc are merged, the cluster set,
cluster template, and closest relation are updated accordingly
(we suppose that Cnc = closest (Cnwin )).
1) Cnc is updated to Cnc = Cnc ∪ Cnwin .
c,l
win,l
2) q c,l
n is calculated by merging q n −1 and q n
q̇yc,l,n = (1 − β)q̇yc,l,n +β



win,l
({q̇x,n
| (x, y) ∈ m}) (25)

qyc,l,n = qyc,l−1,n + q̇yc,l,n
c,l
where q1,n
remains unmodified.

(26)

CASTRO et al.: METHOD FOR CONTEXT-BASED ADAPTIVE QRS CLUSTERING IN REAL TIME

c,l
3) The template is modified to Tnc,l = < q c,l
n , Pn >, where
c,l
Pn is the set of relevant points and support regions obtained of q c,l
n .
4) The closest relation is updated by removing the
(Cnc , Cnwin ) pair and replacing Cnwin by Cnc in all the pairs
where the former appears.
After the cluster Cnwin gets merged, all the modified pairs of
the closest relation are checked for merging. Afterwards, the
Cnc cluster is also checked for merging with its closest one.

V. NOISE-CLUSTER PROLIFERATION CONTROL
The dynamic creation of clusters entails the problem of identifying those QRS complexes contaminated by noise that could
cause the proliferation of clusters. When noise appears in an
ECG lead, the QRS can show different changes. In some cases,
ECG segments with low signal-to-noise ratio present a high
number of waves, and these can be detected by an abnormal
number of dominant points. In other cases, domain knowledge
is needed to discern if changes respond to a new QRS morphology or to a noisy version of a previous one. Some alterations
are well known and described in the literature, but others can
be challenging even for an expert cardiologist, who compares
every beat with those present in its temporal context in order
to identify if it is related to a repetitive morphology change, a
noisy interval, or an isolated noisy beat. We follow a twofold,
beat-based and context-based, approach to detect noisy QRS
complexes. Noise can be present in one or more leads, and the
influence of each lead in the clustering of a given beat will be
analyzed in the following.
A state variable lead noiseln is defined to denote the existence of a noisy interval in lead l containing the nth beat. Such
noisy interval begins when the first noisy beat is detected in
that lead just after a sequence of previous noise-free beats. The
beats contained within this interval can be either noisy or noise
free in l and such condition will be represented as an attribute
of the beat denoted by beat noiseln . During the noisy interval,
the characterization of any new beat Bn can represent not only
QRS waves but also noise artifacts, so the cluster selection and
assignment rules (Section IV-D) are modified in lead l: The dominant points of the beat are ignored, replacing S(q ln , q c,l
n −1 ) by
c,l
c,l
l
l
PS(q ln , q c,l
)
and
S̄(q
,
q
)
by
PS(q
,
q
).
Therefore,
n
n
n −1
n −1
n −1
the condition for beat assignment is PS(q ln , q win,l
n −1 ) > γ.
The ending of a noisy interval in lead l is set just before κ = 3
contiguous beats are considered noise free in that lead. A beat
Bn is considered noise free if beat noiseln = f alse and it is
assigned either to its winner cluster with S̄(q ln , q win,l
n −1 ) > γ or
to a new cluster.
The beat-based noise detection is triggered when a new beat
Bn is detected. Then, the number of waves in the QRS is estimated as |Dnl | for each lead l. If |Dnl | > η, Bn is considered
noisy in lead l and beat noiseln is set to true. The term η is the
maximum number of waves that could be present in a noise-free
QRS. We set η = 6 to admit complexes with Q, R, and S waves,
mixed with R , S or spikes as occurs in paced, fusion, or bundle

1667

branch block beats. Additionally, if |Rnl | > η, the QRS complex
is considered distorted with relevant waves caused by noise. If
this happens in some but not all leads, such leads are ignored for
cluster assignment and updating, but if it happens in all leads,
the beat is considered failed and it is assigned to its most similar
cluster.
The context-based noise detection is activated when a new
cluster is created for Bn . Then two possible explanations are
explored. A first explanation represents a hypothesis of noise
and every noisy beat will be assigned to its most similar cluster. A second explanation simply represents a change in morphology, so creation of new clusters is allowed. The evaluation of these hypothesis is performed over a temporal context of τ beats defined as τ –ctx+ (Bn ) = {Bn +i | 0 ≤ i <
τ } which is long enough to check the evolution of cluster
diversity.
A hypothesis of noise, denoted by hyp noiseln +i , is set over
each lead for every beat Bn +i ∈ τ –ctx+ (Bn ). The hypothesis is initialized using the current noise state for the first beat,
hyp noiseln = lead noiseln −1 , and the value of the previous
beat for each new one, hyp noiseln +i = hyp noiseln +i−1 . This
value can be further modified for a beat Bn +i under three circumstances.
1) If Bn +i is considered noisy in lead l by the beat-based
noise detection, beat noiseln +i = true, then the hypothesis is set to hyp noiseln +i = true.
2) If a new cluster is created for Bn +i , we define Lnoise
n +i
as the set of leads with S̄(q ln +i , q win,l
)
≤
γ,
which
are
n +i−1
responsible for its creation and candidates to be set as
noisy. For these leads, we check the assignment under
noisy interval conditions, PS(q ln +i , q win,l
n +i−1 ) > γ. If the
assignment condition is now fulfilled in all leads, the signal still resemble a previous QRS morphology and we set
hyp noiseln +i = true ∀l ∈ Lnoise
n +i .
3) If Bn +i is the last of κth consecutive noise-free beat, we
set hyp noiseln +i−j = f alse ∀j ∈ [0, κ − 1].
Once the τ beats have been processed, the detection of noisy
leads is addressed. Let Cnctx−new
+τ −1 denote the set of new clusters
created in τ –ctx+ (Bn ). If |Cnctx−new
+τ −1 | > τ /3, we consider that
an abnormal cluster proliferation exists since the appearance of
more than five new QRS morphologies within an interval of 15
beats is an extremely rare condition. Hence, any lead l that is
a common cause of creation, that is, l ∈ Lnoise
n +i , for all i such
that Bn +i ∈ Cnc +i ∧ Cnc +i ∈ Cnctx−new
+τ −1 , is discarded as noisy,
setting hyp noiseln +i = true ∀i ∈ [0, τ − 1].
Finally, the hypothesis is reviewed for every beat Bn +i ∈
τ –ctx+ (Bn ) which caused the creation of a new cluster so
as to decide about its noisy condition. If hyp noiseln +i = true
l
∀l ∈ Lnoise
n +i then we set beat noisen +i = true, the created cluster is deleted and its beats assigned to its closest cluster. Afterwards, lead noiseln +i is updated for the whole τ –ctx+ (Bn )
using the beat noiseln +i data to set the beginning and ending
of noise intervals for each lead. The resulting lead noiseln +τ −1
is the new noise state used in the analysis of the subsequent
beats.

1668

IEEE JOURNAL OF BIOMEDICAL AND HEALTH INFORMATICS, VOL. 19, NO. 5, SEPTEMBER 2015

TABLE I
RULES FOR RHYTHM LABEL SELECTION
Rhythm label for the previous beat
ΔRRn

GP

P

N−

N

N+

C

D

∈ (3
σ n , ∞]

D6
C
C

D2,6
C
C

D

D 1 |1 0
N+
N+

D 2 |1 1
N+
N+

D

D

∈ [−2
σ n , 2
σn ]
σn )
∈ [−3
σ n , −2

N
GP 8
N−

N
N −1
GP

N
N−

N
N−

D 6 |9
N+
N
P4
N−

∈ [−∞, −3
σn )

GP

GP

P 3,4,7
GP 3,12
N−

N
P 3,4,6
GP 3,8
N−
P 3,4,7
GP 3
N−

D5,6
N+
N
P6
GP 8
N−
P 4,7
GP

∈ (2
σ n , 3
σn ]

Fig. 6. Excerpt of the temporal evolution of RR distance for record 117 of
MIT-BIH database is shown. Solid points and squares represent normal and
	 n and the dotted
premature beats, respectively. The solid line represents NN
lines enclose the ±2
σ n and ±3
σ n intervals.

VI. RHYTHM ANALYSIS
The absence of an analysis of the P wave leads to the inability
to discriminate premature, normal, or ectopic beats which share
a common QRS morphology. All previous clustering proposals
include rhythm information within their beat characterization
and claim its separation capabilities for this kind of arrhythmias. In order to make our results comparable, we include a
rhythm processing stage that allows us to separate those beats
into different groups.
A. RR-Interval Characterization
The beat-to-beat interval (RR) between normal beats, commonly known as NN interval, is the result of a nonstationary
stochastic process regulated by the sympathetic and parasympathetic nervous systems. This implies that the RR value for
beat Bn , denoted by RRn , should be put in context using the
rhythm of the surrounding beats to analyze its normality. To
this end, we model the NN series as a stochastic process with
marginal distribution N̄ (NN n , σn2 ) at the nth beat. The mean is

 n −1 , with θ = 0.2

 n = θRRn −1 + (1 − θ)NN
estimated as NN
for RRn −1 values labeled as normal (as explained in next sec
 n = NN

 n −1 . The standard deviation is
tion). Otherwise, NN

2

 i using the last τ beats with
estimated as σ
n = i NNi − NN
normal rhythm. Fig. 6 shows the evolution of the RR in an excerpt with a premature beat from the record 117 of the MIT-BIH
database to illustrate this point.
The first complete context, τ –ctx− (Bτ +1 ), is used to ini
 n and σ
n . Let T C denote the set of the first τ
tialize NN
values of RR and let Ki denote any subset of RR values from consecutive beats. A value RRj ∈ T C is said to
be normal if ∃Ki such that RRj ∈ Ki ∧ σK i < 0.1, where
σK i is the normalized standard deviation of the Ki set. Let
T CN = {RRj | RRj is normal}. If T CN = ∅, then T CN =
{RRj | RRj ∈ [T C − 2σT C , T C + 2σT C ]}, where T C and
σT C are the mean and standard deviation of T C. If T CN = ∅,

N+

P4
GP

P4
GP

1. R R n > R R n− + 4
σn
2. R R n > R R n− + 3
σn
3. R R n < R R n− − 3
σn
4. R R n < R R n+ − 3
σn

 n + 3

 n + 3
5. R R n− > NN
σn
6. R R n+ > NN
σn

 n − 3

 n − 3
7. R R n+ > NN
σn
8. R R n+ < NN
σn

 n − 2
9. R R n+ > NN
σn
10. R R n+ > R R n− + 4
σn
11. R R n+ > R R n− + 3
σn
12. R R n+ < R R n− − 3
σn

 n . The superscripts refer the conditions listed below and
Δ R R n stands for R R n − NN
used when multiple candidate labels exist. They impose a minimum distance between
normal and premature or delayed beats. The precedence of label candidates is set by order
of appearance.

then the context in T C is repeatedly moved forward one beat
until T CN = ∅ for a context τ –ctx− (Bτ +1+i ). Finally, we set

 n = T C N and σ
NN
n = σT C N ∀n ∈ [1, τ + 1 + i].
B. Rhythm Labeling
The aim of rhythm processing is the discrimination of those
abnormal RR values associated with arrhythmic beats from the
normal ones. To this end, the rhythm of the Bn beat is charac
n, σ
terized through a vector rr n = (RRn , RRn− , RRn+ , NN
n )
−
+
where RRn and RRn are the RR values for the previous and
next beat, respectively. Then, the model described in the previous section is used to establish a range of validity for the RRn
value which allows us to detect any alteration in the normal
rhythm.
We use seven rhythm labels to discern between four beat
rhythm types: Normal, with (C) or without (N , N − , N + ) compensatory pause, premature (P ), group of prematures (GP ),
and delayed (D). The explicit domain knowledge contained in
Table I models, for each rhythm type, the relation of an RR
value with the normal rhythm from its temporal context. It also
reflects the dependence of the rhythm type for an RR value on
the rhythm type of its adjacent beats. This model allows us to
assign a rhythm label to the beat Bn based on the rrn values
and the rhythm label of the previous beat.
VII. RESULTS
We have applied our clustering method to all the records
of the MIT-BIH database. The parameters and threshold values of this method have been neither trained nor adjusted to fit
this database. These values have been justified by physiological
reasons, or by the expertise or intuition of experienced cardiologists. The method shows low sensitivity to small changes in
parameter values; the results either improve or worsen slightly.

CASTRO et al.: METHOD FOR CONTEXT-BASED ADAPTIVE QRS CLUSTERING IN REAL TIME

TABLE II
NUMBER OF CLUSTERS PER RECORD IN MIT-BIH DB
Rec.

N

NR R

NcR R

Rec.

N

NR R

NcR R

100
101
102
103
104
105
106
107
108
109
111
112
113
114
115
116
117
118
119
121
122
123
124
200

4
4
10
10
16
10
27
11
22
13
8
4
5
8
11
10
4
3
6
5
1
3
14
20

7
6
13
12
25
16
49
21
35
18
10
7
9
13
11
15
5
8
13
7
1
5
18
46

7
6
13
12
25
16
18
21
7
18
10
7
9
13
11
15
5
8
13
7
1
5
18
16

201
202
203
205
207
208
209
210
212
213
214
215
217
219
220
221
222
223
228
230
231
232
233
234

15
9
33
14
61
28
10
27
5
17
21
16
28
14
2
14
8
23
14
3
5
4
24
5

32
18
87
20
96
63
26
65
8
29
36
32
50
24
5
24
19
43
25
5
6
9
48
7

10
18
25
20
25
22
9
13
8
11
11
8
19
24
5
24
19
17
25
5
6
9
15
7

N column indicates the number of clusters created using QRS morphology; NR R , the number of groups after using rhythm labels;
and NcR R , the number of groups after the merging process.

Although better results could be obtained by a fine tuning of
these parameters for each specific database, this is not the aim
of this paper but proving the validity of the present approach for
continuous ECG monitoring.
For each record, a set of clusters is obtained reflecting the QRS
morphologies present in them. Afterwards, the rhythm labels
are used to split each cluster into groups of beats with the same
rhythm type. In order to compare our results with the proposal
in [5] under equivalent conditions, we adopted a fixed number
of clusters (25) as the maximum number of groups. Thus, if that
limit is exceeded for a record, a merging process is applied to
obtain a reduced set of groups with the most prevalent rhythm
and morphologies. If necessary, we keep merging the groups
with the lowest number of assigned beats until the maximum is
reached. Table II shows the results before and after the merging
process.
Each group is labeled with the majority class label of the beats
assigned to this group from the database. An assigned beat is
considered as correctly grouped if the class label in the database
match the label of the group. A confusion matrix is obtained
for each record comparing both labels for every beat. These
matrices are summed to obtain the global confusion matrix for
the whole validation set shown in Table III. Table IV shows the
results using the AAMI class labels obtained from MIT-BIH
labels as described in [15]. Table V shows the results on AHA
database.
A. Real-Time Considerations
The proposed method processes an ECG recording with
a bounded time delay comprising the intrinsic latency and

1669

computation time for the different stages. Only the baseline
filtering and rhythm labeling stages present an intrinsic latency
due to noncausality: 400 ms and one beat, respectively. Since
they both are executed concurrently, their contribution to the
delay is given by the maximum of both. The time complexity of
the method is constant in all stages but two: QRS alignment and
template matching. In both cases, time complexity is constant
for the best case, corresponding to beats assigned to a cluster in
the context; this happens in 95.35% of the total number of beats
in MIT-BIH database. Time complexity is linear (O(|Cn |)) for
the worst case, which corresponds to beats assigned to a new or
an out-of-context cluster, representing the remaining 4.65% of
the total number of beats. Given the high degree of parallelism
in both stages and the computational cost of processing a single
cluster, it can be guaranteed that a beat is clustered before the
next one arrives even with a set of hundreds of clusters. In order
to support this claim, the MIT-BIH Arrhythmia database was
processed with a nonoptimized, nonparallelized MATLAB implementation of the method using a single core of an Intel Q9550
CPU. The following computation times for a single beat were
obtained: QRS characterization (maximum, mean): 4 ms, 3 ms;
cluster set selection: 323 ms, 16 ms; cluster set updating: 110 ms,
5 ms; noise analysis: 9 ms, <1 ms; and rhythm-based labelling:
10 ms, 5 ms. Globally, the whole method summed a maximum
of 358 ms and mean of 32 ms. Additionally, reducing groups
for validation required a maximum of 190 ms.
B. Clustering Performance Measures
Purity is usually used to measure the goodness of a clustering
method. Nevertheless, in a multiclass problem like this one, after
characterizing the clusters, the values of sensitivity (Se), positive
predictivity (+P), and false positive rate (FPR) should also be
provided for each class, in order to obtain a multidimensional
measure of the quality of the results from the perspective of each
class involved. A global purity of 98.56% is obtained for MITBIH Arrhythmia database (98.84% with AAMI class labels)
and a 99.56% for the AHA ECG database. The other values are
shown in the last row of Tables III–V.
VIII. DISCUSSION AND CONCLUSION
We propose a new clustering method to dynamically separate
QRS morphologies as they appear in a multichannel ECG signal, representing them with a dynamic number of clusters. This
objective has not been previously addressed in the literature and
only some partial solutions can be found; all of them restricted
to offline processing [5]–[7] and some of them even limited
to single channel signals and to a fixed subset of beat classes
[6], [7].
The performance of the QRS clustering technique without
using rhythm data shows a global purity of 97.15% and 99.43%
for MIT-BIH and AHA databases, respectively. This confirms
the validity of our approach since no method, as far as we know,
neither offline nor online, achieve this performance without using RR derived information. As expected, the main source of
error is the group of supraventricular classes A, N, J, j, and e,
that can only be separated using P wave and rhythm information.

1670

IEEE JOURNAL OF BIOMEDICAL AND HEALTH INFORMATICS, VOL. 19, NO. 5, SEPTEMBER 2015

TABLE III
CONFUSION MATRIX RESULTING FROM CLUSTERING MIT-BIH ARRHYTHMIA DATABASE

N
L
R
a
V
F
J
A
S
E
j
/
e
f
Q
!
Se
+P
FPR

N

L

R

a

V

F

J

A

S

E

j

/

e

f

Q

!

74618
0
32
7
131
26
1
44
0
0
145
9
0
9
0
0
99.46
99.17
1.79

0
8059
0
0
1
0
0
4
0
0
0
0
0
0
0
8
99.84
99.94
0.00

3
0
7245
0
0
0
0
3
0
2
0
0
0
0
0
0
99.89
98.79
0.09

15
0
0
120
11
2
0
2
0
0
0
0
0
0
0
0
80.00
88.24
0.01

167
1
1
1
6848
56
0
25
0
10
0
1
0
5
0
12
96.09
96.38
0.25

108
2
3
0
83
606
0
0
0
0
0
0
0
0
0
0
75.56
87.57
0.08

11
0
29
1
0
0
42
0
0
0
0
0
0
0
0
0
50.60
97.67
0.00

196
0
8
2
20
2
0
2317
0
0
0
0
0
0
0
0
91.04
94.38
0.13

2
0
0
0
0
0
0
0
0
0
0
0
0
0
0
0
0.00
0.00

1
0
6
0
0
0
0
0
0
93
0
0
0
0
0
6
87.74
88.57
0.01

60
0
6
5
0
0
0
0
0
0
158
0
0
0
0
0
69.00
52.15
0.13

1
0
0
0
0
0
0
0
0
0
0
7010
0
13
0
0
99.80
98.08
0.13

15
0
0
0
0
0
0
1
0
0
0
0
0
0
0
0
0.00
0.00

38
0
0
0
1
0
0
0
0
0
0
127
0
816
0
0
83.10
95.10
0.04

9
2
0
0
4
0
0
0
0
0
0
0
0
15
3
0
9.09
100.00
0.00

0
0
4
0
6
0
0
59
0
0
0
0
0
0
0
403
85.38
93.94
0.02

The first row corresponds to the annotation labels of the database, and the first column, to the dominant annotation label in the clusters. Se, + P , and F P R denote
the sensitivity, positive predictivity, and false positive rate for each beat class, respectively.

TABLE IV
CONFUSION MATRIX FOR MIT-BIH DB USING AAMI CLASS LABELS

N
S
V
F
Q
Se
+P
FPR

N

S

V

F

Q

89957
204
134
26
18
99.58
99.25
3.57

342
2648
31
4
0
87.54
92.01
0.22

176
26
6951
56
6
96.34
96.49
0.25

113
0
83
606
0
75.56
87.57
0.08

50
0
5
0
7984
99.32
99.70
0.02

This is the reason for the difference between both results since
AHA database does not contain this type of beats.
The validation results after using rhythm labels show a high
sensitivity and positive predictivity for almost all classes while
the purity increases. We observe in accordance with [5], that the
largest number of errors in Table III are caused by beats with
similar morphology. Fusion (F) of ventricular (V) and normal
(N) beats are included with N or V clusters and viceversa. The
same occurs with N, paced (/) and fusion of N and / beats (f).
Finally, beats with supraventricular or nodal activation points
(A, N, J, j, and e) with similar QRS are wrongly clustered when
the rhythm information does not result determinant for their
discrimination. This kind of errors represent 66% of the total.
Besides the clustering performance, the analysis of the number of clusters (N) generated for each record shows that it remains reduced: 34 records (71%) have 15 or less clusters; 12
records (25%) have between 16 and 30 clusters, both included
and only two records (4%) has more than 30 clusters. The high
number of clusters for record 207 is caused by the presence of
an episode of ventricular flutter with QRS complexes replaced
by irregular waves. The clustering results would be improved
if an specific detection method were used for these kind of
arrhythmias with absent QRS complex.

TABLE V
CONFUSION MATRIX FOR AHA ECG DATABASE

N
V
F
E
/
Q
Se
+P
FPR

N

V

F

E

/

Q

318739
229
33
0
5
11
99.91
99.75
2.07

472
32090
115
0
23
32
98.04
98.40
0.16

138
217
885
0
26
0
69.91
84.29
0.04

7
0
0
5
0
0
41.67
100.00
0.00

16
9
16
0
3128
0
98.71
98.27
0.02

150
66
1
0
1
354
61.89
89.17
0.01

Classes from the MIT-BIH label set without assigned beats are omitted.

The NRR column of Table II shows a general increase in
the number of groups in all records with a mean of 24 groups
per record. This increment reflects the presence of different
rhythm labels in the beats assigned to the clusters although
they do not always belong to different beat classes. Records
with irregular rhythm like those with auricular fibrillation, or
sudden rhythm change will render the RR information useless
to discriminate premature or delayed beats. In such cases, the
RR does not provide information about the beat activation point
and the discrimination cannot be performed without an analysis
of the P wave.
Since no other method for online clustering has been reported,
we compare our clustering performance with existing offline
proposals. Only the work of Lagerholm et al. [5] provides comparable results since others [6], [7] are designed to deal with a
concrete subset of beat types and perform the evaluation over a
single channel (usually the one with lower noise). Compared to
[5], our method provides a slightly better purity (98.56% versus 98.49%). The sensitivity is improved in our paper for 11
out of the 16 beat classes and slightly worsened for 3. Special
mention should be made for classes a, A, R, j, and E where the

CASTRO et al.: METHOD FOR CONTEXT-BASED ADAPTIVE QRS CLUSTERING IN REAL TIME

improvement is remarkable. Let us remember that Lagerholm
et al. [5] rely on a SOM with 25 clusters to represent the different beat classes. This approach has two main drawbacks, first
the clusters get saturated with dominant morphologies present
in the learning stage, while rare morphologies are ignored as
well as new morphologies that appear afterwards. Second, the
generated clusters are redundant in those records with a low
number of morphologies. In contrast, our method dynamically
adapts the number of clusters to the number of morphologies
detected.
The results of our proposal confirm the relevance of the temporal context for beat clustering. It allows us to switch from an
offline to an online analysis achieving the same or even better
results, and to address the temporal evolution of a beat morphology that otherwise would be projected into multiple clusters.
The results of the experiments on ECG standard databases also
show the adequacy of the present method for real-time ECG
monitoring.
Our proposal provides the cardiologists with the information
about the morphological diversity within a desired time frame
and its temporal evolution. This information allows them to
promptly detect the different conduction patterns and evaluate
its relevance. It also can be useful for arrhythmia detection and
classification which can be later addressed either automatically
by classification algorithms or manually by the cardiologists.
In conclusion, we have presented an adaptive, multichannel
context-based method for clustering beat morphologies in real
time that has been validated over the whole MIT-BIH Arrhythmia and AHA ECG databases with performance results that
outperform its offline counterparts in the field.

[11]
[12]
[13]
[14]
[15]
[16]

[17]
[18]
[19]
[20]
[21]

[22]
[23]

1671

ECG descriptors for heartbeat classification,” Med. Eng. Phys., vol. 28,
no. 9, pp. 876–887, 2006.
S. Osowski and T. H. Linh, “ECG beat recognition using fuzzy hybrid
neural network,” IEEE Trans. Biomed. Eng., vol. 48, no. 11, pp. 1265–
1271, Nov. 2001.
S. Osowski, L. T. Hoai, and T. Markiewicz, “Support vector machine-based
expert system for reliable heartbeat recognition,” IEEE Trans. Biomed.
Eng., vol. 51, no. 4, pp. 582–589, Apr. 2004.
Y. H. Hu, S. Palreddy, and W. J. Tompkins, “A patient-adaptable ECG
beat classifier using a mixture of experts approach,” IEEE Trans. Biomed.
Eng., vol. 44, no. 9, pp. 891–900, Sep. 1997.
Z. Dokur and T. Olmez, “Ecg beat classification by a novel hybrid neural
network,” Comput. Methods Prog. Bio., vol. 66, nos. 2/3, pp. 167–181,
2001.
Testing and Reporting Performance Results of Cardiac Rhythm
and ST-segment Measurement Algorithms. ANSI/AAMI Standard
EC57:1998/(R)2008, 2008.
A. L. Goldberger, L. A. N. Amaral, L. Glass, J. M. Hausdorff, P. C.
Ivanov, R. G. Mark, J. E. Mietus, G. B. Moody, C.-K. Peng, and H. E.
Stanley, “PhysioBank, PhysioToolkit, and PhysioNet: Components of a
new research resource for complex physiologic signals,” Circulation, vol.
101, no. 23, pp. e215–e220, 2000.
G. Moody and R. Mark, “The impact of the MIT-BIH Arrhythmia
Database,” IEEE Eng. Med. Biol. Mag., vol. 20, no. 3, pp. 45–50, May/Jun.
2001.
W.-Y. Wu, “An adaptive method for detecting dominant points,” Pattern
Recog., vol. 36, no. 10, pp. 2231–2237, 2003.
The CSE Working Party, “Recommendations for measurement standards in quantitative electrocardiography,” Eur. Heart. J., vol. 6, no. 10,
pp. 815–825, 1985.
Cardiac Monitors, Heart Rate Meters, and Alarms. ANSI/AAMI Standard
EC13:2002/(R)2007, 2007.
P. Kligfield, L. S. Gettes, J. J. Bailey, R. Childers, B. J. Deal, E. W. Hancock, G. van Herpen, J. A. Kors, P. Macfarlane, D. M. Mirvis, O. Pahlm,
P. Rautaharju, and G. S. Wagner, “Recommendations for the standardization and interpretation of the electrocardiogram: Part I,” Circulation, vol.
115, no. 10, pp. 1306–1324, 2007.
H. Sakoe, and S. Chiba, “Dynamic programming algorithm optimization
for spoken word recognition,” IEEE Trans. Acoust., Speech, Signal Process., vol. 26, no. 1, pp. 43–49, Feb. 1978.
E. J. Keogh, and M. J. Pazzani, “Derivative dynamic time warping,” presented at the 1st SIAM Int. Conf. Data Mining, Chicago, IL, USA, 2001.

REFERENCES
[1] R. Sutton, “Remote monitoring as a key innovation in the management
of cardiac patients including those with implantable electronic devices,”
Europace, vol. 15, no. 1, pp. i3–i5, 2013.
[2] P. DeChazal, M. O’Dwyer, and R. B. Reilly, “Automatic classification of
heartbeats using ECG morphology and heartbeat interval features,” IEEE
Trans. Biomed. Eng., vol. 51, no. 7, pp. 1196–1206, Jul. 2004.
[3] M. Llamedo and J. P. Martı́nez, “Heartbeat classification using feature
selection driven by database generalization criteria,” IEEE Trans. Biomed.
Eng., vol. 58, no. 3, pp. 616–625, Mar. 2011.
[4] G. de Lannoy, D. François, J. Delbeke, and M. Verleysen, “Weighted conditional random fields for supervised interpatient heartbeat classification,”
IEEE Trans. Biomed. Eng., vol. 59, no. 1, pp. 241–247, Jan. 2012.
[5] M. Lagerholm, C. Peterson, G. Braccini, L. Edenbrandt, and L. Sornmo,
“Clustering ECG complexes using Hermite functions and self-organizing
maps,” IEEE Trans. Biomed. Eng., vol. 47, no. 7, pp. 838–848, Jul. 2000.
[6] D. Cuesta-Frau, J. C. Pérez-Cortes, and G. A. Garcı́a, “Clustering of
electrocardiograph signals in computer-aided holter analysis,” Comput.
Methods Prog. Bio., vol. 72, no. 3, pp. 179–196, 2003.
[7] D. Cuesta-Frau, M. O. Biagetti, R. A. Quinteiro, P. Micó-Tormos, and
M. Aboy, “Unsupervised classification of ventricular extrasystoles using
bounded clustering algorithms and morphology matching,” Med. Biol.
Eng. Comput., vol. 45, no. 3, pp. 229–239, 2007.
[8] J. L. Rodrı́guez-Sotelo, D. Cuesta-Frau, and G. Castellanos-Domı́nguez,
“Unsupervised classification of atrial heartbeats using a prematurity index
and wave morphology features,” Med. Biol. Eng. Comput., vol. 47, no. 7,
pp. 731–741, 2009.
[9] V. Krasteva and I. Jekova, “ QRS template matching for recognition of
ventricular ectopic beats,” Ann. Biomed. Eng., vol. 35, pp. 2065–2076,
Sep 2007.
[10] I. Christov, G. Gómez-Herrero, V. Krasteva, I. Jekova, A. Gotchev, and
K. Egiazarian, “Comparative study of morphological and time-frequency

Daniel Castro received the B.Sc. and M.Sc. degrees in physics from the University of Santiago de Compostela, Santiago de Compostela, Spain, in 1998 and
1999, respectively. He is a Researcher and currently working toward the Ph.D.
degree at the Centro Singular de Investigación en Tecnoloxı́as da Información,
University of Santiago de Compostela.
His research interests include signal processing and its application to biomedical signals.
Paulo Félix received the B.Sc. and Ph.D. degrees
in physics from the University of Santiago de Compostela, Santiago de Compostela, Spain, in 1993 and
1999, respectively.
He is currently a Researcher at the Centro Singular de Investigación en Tecnoloxı́as da Información,
University of Santiago de Compostela. His research
interests include temporal reasoning, machine learning, and signal processing.

Jesús Presedo received the B.Sc. and Ph.D. degrees
in physics from the University of Santiago de Compostela, Santiago de Compostela, Spain, in 1989 and
1994, respectively.
He is currently a Researcher at the Centro Singular de Investigación en Tecnoloxı́as da Información,
University of Santiago de Compostela. His research
interests include biomedical digital signal processing,
heart rate variability, nonlinear dynamics, soft computing, and the development of ubiquitous healthcare
systems.

