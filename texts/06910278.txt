IEEE TRANSACTIONS ON BIOMEDICAL ENGINEERING, VOL. 62, NO. 2, FEBRUARY 2015

553

Micromagnetometer Calibration for Accurate
Orientation Estimation
Zhi-Qiang Zhang‚àó and Guang-Zhong Yang, Fellow, IEEE

Abstract‚ÄîMicromagnetometers, together with inertial sensors,
are widely used for attitude estimation for a wide variety of applications. However, appropriate sensor calibration, which is essential to
the accuracy of attitude reconstruction, must be performed in advance. Thus far, many different magnetometer calibration methods
have been proposed to compensate for errors such as scale, offset,
and nonorthogonality. They have also been used for obviate magnetic errors due to soft and hard iron. However, in order to combine
the magnetometer with inertial sensor for attitude reconstruction,
alignment difference between the magnetometer and the axes of
the inertial sensor must be determined as well. This paper proposes a practical means of sensor error correction by simultaneous
consideration of sensor errors, magnetic errors, and alignment difference. We take the summation of the offset and hard iron error as
the combined bias and then amalgamate the alignment difference
and all the other errors as a transformation matrix. A two-step
approach is presented to determine the combined bias and transformation matrix separately. In the first step, the combined bias is
determined by finding an optimal ellipsoid that can best fit the sensor readings. In the second step, the intrinsic relationships of the
raw sensor readings are explored to estimate the transformation
matrix as a homogeneous linear least-squares problem. Singular
value decomposition is then applied to estimate both the transformation matrix and magnetic vector. The proposed method is then
applied to calibrate our sensor node. Although there is no ground
truth for the combined bias and transformation matrix for our
node, the consistency of calibration results among different trials
and less than 3‚ó¶ root mean square error for orientation estimation have been achieved, which illustrates the effectiveness of the
proposed sensor calibration method for practical applications.
Index Terms‚ÄîCalibration, ellipsoid fitting, homogeneous linear
least squares, magnetometer, system identification.

I. INTRODUCTION
N conjunction with inertial sensors, micromagnetometers
have been widely used to determine attitude information,
which can be applied for a variety of applications, from delivering realistic animation in filming and entertainment to assessing
the performance of professional athletes [1], [2]. Clinically, it
can also be used to analyze the biomechanics of patients. The
analysis provides an objective measure of physical function
to aid interventional planning, evaluate the outcomes of surgical procedures, which are exceptionally beneficial for many

I

Manuscript received August 13, 2014; revised September 18, 2014; accepted
September 18, 2014. Date of publication September 25, 2014; date of current
version January 16, 2015. Asterisk indicates corresponding author.
‚àó Z.-Q. Zhang is with the Hamlyn Centre for Robotic Surgery, Imperial College London, SW7 2AZ London, U.K. (e-mail: z.zhang@imperial.ac.uk).
G.-Z. Yang is with the Hamlyn Centre for Robotic Surgery, Imperial College
London, SW7 2AZ London, U.K (e-mail: g.z.yang@imperial.ac.uk).
Color versions of one or more of the figures in this paper are available online
at http://ieeexplore.ieee.org.
Digital Object Identifier 10.1109/TBME.2014.2360335

biomedical applications, such as rehabilitation [3], [4], fall detection [5], [6] and gait analysis [7], [8]. Thus far, extensive
research has been performed in order to accurately estimate
attitude information from microinertial and magnetic sensor
measurements [9], [10]. In practice, the achievable accuracy
of attitude estimation is highly dependent on the quality of the
sensor measurements. Therefore, appropriate sensor calibration,
as the important prerequisite step for attitude estimation, must
be performed in advance to compensate for errors in sensor
readings.
Recently, many magnetometer calibration methods have been
proposed to compensate for sensor errors (such as scale factor, offset, nonorthogonality) and magnetic errors (soft and hard
iron) [11], [12]. For instance, Gambhir [13] proposed to use centering approximation to formulate the bias calibration problem
in the linear least-squares form. Alonso et al. [14], [15] further
improved Gambhir‚Äôs approach in terms of robustness and efficiency. These two methods are easy to implement in practice,
but they only consider the bias error with all the other error
sources ignored. In recent papers, more advanced magnetometer calibration algorithms have been proposed. They not only
consider the bias error but also tackle sensitivity, nonorthogonality, and magnetic errors in the sensor space. For example,
both Elkaim et al. [16] and Gebre-Egziabher et al. [17] have formulated the calibration problem in a pseudo-linear least-squares
form. Batch-linearized least-squares algorithms were derived to
obtain the calibration parameters including nonorthogonality,
magnetic, sensitivity, and bias. Renaudin et al. [18] proposed a
complete model to compensate for sensor and magnetic errors.
An adaptive least-squares estimator, which provided a consistent solution to the ellipsoid fitting problem has been derived.
Based on the similar sensor error model, Vasconcelos et al. [19]
proposed an iterative Maximum Likelihood Estimator (MLE)
which allowed for the formulation of the calibration problem
as an optimization process in terms of the likelihood of sensor readings. Such method, however, is influenced by the initial
approximation, which may make the MLE converge to a local
maximum. To overcome this drawback, Wu et al. [20] proposed
to use a particle swarm optimization strategy combined with
a stretching technique, which could help to eliminate the local
maxima. Springmann and Cutler et al. [21] and Pang et al. [22]
presented similar work for magnetometer calibration. However,
all the aforementioned calibration methods only considered the
magnetometer calibration in its sensor frame. In order to integrate the magnetometer with inertial sensor for attitude estimation, the alignment difference between the magnetometer and
the inertial sensor axes should also be considered during the
calibration process.

0018-9294 ¬© 2014 IEEE. Personal use is permitted, but republication/redistribution requires IEEE permission.
See http://www.ieee.org/publications standards/publications/rights/index.html for more information.

554

IEEE TRANSACTIONS ON BIOMEDICAL ENGINEERING, VOL. 62, NO. 2, FEBRUARY 2015

In fact, there are also several studies estimating the alignment
difference by simultaneous calibration of inertial and magnetic
sensors. For instance, Bonnet et al. [11] proposed to estimate
the difference by finding three vectors in magnetometer sensor
frame and their corresponding vectors in the reference inertial frame, but it is difficult to find such vectors in practice.
Kow et al. [12] derived an easy-to-use calibration algorithm
that could be used to calibrate a combination of a magnetometer and inertial sensors. They made use of probabilistic models
and obtained the calibration algorithm as the solution to a maximum likelihood problem. In [23], they further extended this
study and proposed to use gray-box system identification approach to simplify the computation of the maximum likelihood
estimates. The method can be used to estimate the alignment
difference between the axes of the magnetometer and the inertial sensor, albeit being complex to implement in practice.
In our previous study [24], similar work has been conducted
but we ignored such alignment difference in our calibration
process.
The motivation of this paper is to further extend our previous paper in [24] and tackle the sensor errors, magnetic errors, and also the alignment difference between the axes of
the magnetometer and the inertial sensor. With the proposed
approach, we take the summation of the offset and hard iron
error as the combined bias and then amalgamate the alignment difference and all the other errors as a transformation
matrix. A two-step approach is adopted to determine the combined bias and transformation matrix separately. In the first
step, the combined bias is determined by finding the optimal
ellipsoid that can best fit the sensor readings. Subsequently, the
intrinsic relationships of the sensor readings are explored to
determine the transformation matrix by using a homogeneous
linear least-squares method. Singular value decomposition is
used to estimate both the transformation matrix and magnetic
vector. The remainder of this paper is organized as follows. Section II presents the proposed approach for micromagnetometers
calibration, including the sensor error model, combined bias
estimation, and transformation matrix determination. Detailed
simulation and experimental results are described in Section
III and the conclusion derived from the studies is presented in
Section IV

can be written as

‚é°

0

0

‚é§

‚é¢
T = ‚é£Œ±

1

‚é•
0‚é¶.

Œ≤

Œ≥

1

(1)

The offset of the sensor readings is modeled as a constant bias
vector b = [bx , by , bz ]T . The raw senor reading is directly proportional to the voltage level, which should be converted to
physical quantities through a scale factor matrix S as
‚é§
‚é°
sx 0 0
‚é•
‚é¢
S = ‚é£ 0 sy 0 ‚é¶ .
(2)
0 0 sz
2) Magnetic Errors: In practice, the external magnetic field
can introduce both hard iron and soft iron errors. The hard
iron effect is due to remanence of magnetized iron materials, which is constant and can be represented by a bias vector
bhi = [bxhi , byhi , bzhi ]T . Soft iron errors are generated by the interaction of the external magnetic field with the ferromagnetic
materials in the vicinity of the sensor. This changes the intensity,
as well as the direction of the sensed magnetic field. The soft
iron effect is usually modeled by a 3√ó3 matrix
‚é§
‚é° 11
a13
asi a12
si
si
‚é•
‚é¢
a22
a23
(3)
Asi = ‚é£ a21
si
si
si ‚é¶ .
a31
si

a32
si

a33
si

3) Alignment Difference: For orientation estimation, the
magnetometer is usually mounted together with the inertial
sensors. The geometrical relationship of the axes of different
sensors‚Äô orthogonal sensitivity is important, especially with respect to the overall system accuracy. In practice, the orthogonal
sensitivity axes are aligned to the inertial coordinate through a
rotation matrix R as
R = Rz (œà)Ry (Œ∏)Rx (œÜ)
where

‚é°

1

0

(4)
‚é§

0

‚é¢
‚é•
Rx (œÜ) = ‚é£ 0 cos(œÜ) ‚àísin(œÜ) ‚é¶
0

II. OUR METHOD
‚é°

A. Sensor Error Model
For the description of micromagnetometers, all sensor readings should be first converted to physical quantities in metric
units. To this end, there are mainly three types of errors that
need to be distinguished: sensor errors, magnetic errors, and
alignment difference between the axes of the magnetometer and
the inertial sensor.
1) Sensor Errors: A triaxial sensor has three sensitivity axes
x, y, and z, spanning a 3-D space. Ideally, the sensor sensitivity
axes should be orthogonal to each other, but due to inevitable
imperfection during the fabrication process, this is not guaranteed. Therefore, orthogonalization of the axes is necessary.
Denote T as the Gram‚ÄìSchmidt orthogonalization matrix, so T

1

‚é¢
Ry (Œ∏) = ‚é£

sin(œÜ)

(5)

cos(œÜ)

cos(Œ∏)

0

sin(Œ∏)

0

1

0

‚é§
‚é•
‚é¶

(6)

‚àísin(Œ∏) 0 cos(Œ∏)
and

‚é°

cos(œà)

‚é¢
Rz (œà) = ‚é£ sin(œà)
0

‚àísin(œà)
cos(œà)
0

0

‚é§

‚é•
0‚é¶.

(7)

1

4) Error Parameterization: After combing the sensor errors,
magnetic errors, and alignment difference, the three-axis magnetometer measurement can be represented by using the following

ZHANG AND YANG: MICROMAGNETOMETER CALIBRATION FOR ACCURATE ORIENTATION ESTIMATION

error model [12][18]:
u = RTSAsi (g ‚àí b ‚àí bhi )

(8)

where u is the measured physical quantities in metric unit in the
inertial coordinate, and the g is sensor voltage readings in the
nonorthogonal magnetometer coordinate frame.
The purpose of sensor calibration is to estimate the value of
the parameter vector

Œ∂ = Œ±, Œ≤, Œ≥, œÜ, œà, Œ∏, sx , sy , sz , bx , by , bz ,

Thus, we can normalize the above equation as
 T
H
H
T
¬∑ (gj ‚àí B) = 1.
¬∑
(gj ‚àí B) ¬∑
M
M

(gj )T ¬∑ Œ£ ¬∑ gj ‚àí (gj )T ¬∑ Œì + Œ• = 0
where

(9)

Œ∂

subject to
(10)

where
J 
2




uj ‚àí RTSAsi (gj ‚àí b ‚àí bhi )

B. Combined Bias Estimation

(17)

(H)T ¬∑ H = M 2 Œ£ÃÇ
1  ‚àí1
B=
ŒìÃÇ.
Œ£ÃÇ
2

(18)

Since Œ£ÃÇ is a positive definite matrix, an eigen-decomposition
can be applied:
Œ£ÃÇ = ŒõDŒõT

(19)

where Œõ corresponds to the eigenvectors of Œ£ÃÇ, and D is the
diagonal matrix containing the eigenvalues, so we can define
another matrix K as
‚àö
(20)
K = M Œõ DŒõT
satisfying

‚àö
‚àö
K T K = M Œõ DŒõT M S DŒõT
= M 2 ŒõDŒõT
= M 2 Œ£ÃÇ.

(21)

However, given any rotational matrix Œ©, we can also have
‚àö
‚àö
(Œ©K)T Œ©K = M S DŒõT Œ©T Œ©M Œõ DŒõT
= M 2 ŒõDŒõT

After defining the combined bias B and the transformation
matrix H, the new sensor error model can be written as
(12)

For any sensor reading gj , we can have
(13)

By expanding the above equation, we can get
(gj ‚àí B)T ¬∑ (H)T ¬∑ H ¬∑ (gj ‚àí B) = M 2 .

H
M

This equation is the algebraic equation of an ellipsoid [19], [24],
and the calibration problem now becomes finding an arbitrarily
oriented ellipsoid which fits the J points g1 , g2 , . . . , gJ best.
There is an abundant literature addressing this problem [25]‚Äì
[27]. For this study, the least-squares ellipsoid fitting method
proposed in [27] is used, and the value of Œ£, Œì and Œ• can be
then obtained. Denote the estimates for Œ£ and Œì as Œ£ÃÇ, ŒìÃÇ, we can
then have the following properties for H and B:

(11)

uj is the measured physical quantity for the sensor reading gj ,
|¬∑| and  ¬∑  are the magnitude and Frobenius norm operators,
respectively. Here, j is the index of different orientation or rotation that the sensor node is set to. In (10), we implicitly assume
that all the magnetic distortion and local magnetic field are constant. This is a reasonable assumption as long as the sensor node
is placed at the same position in different orientations during the
calibration process.
In practice, it is difficult to find a globally optimized solution
for Œ∂ due to the difficulty of acquiring uj . Since the main purpose
of the sensor calibration is to find an accurate u for any sensor
reading g, there is no need to estimate the 24 parameters individually. Therefore, we propose a two-step parameter estimation
scheme to simplify the optimization process, i.e., 1) estimate
the combined bias B = b + bhi , 2) estimate the transformation
matrix H = RTSAsi . The advantage of combining the different
parameters together is not only to reduce the unknown parameters from 24 to 12, but also to take the other unmodeled linear
time invariant errors and distortions into account.

|H ¬∑ (gj ‚àí B)| = M.

T

Œ• = (B)T ¬∑ Œ£ ¬∑ B ‚àí 1.

j =1

u = H(g ‚àí B).

H
M

(16)

Œì = 2Œ£ ¬∑ B

given J sensor raw readings gj , where j = 1, 2, . . . , J and the
magnitude of the local magnetic field M . The estimation of Œ∂
can be written as

L(Œ∂) =


Œ£=

33
bxhi , byhi , bzhi , a11
si , . . . , asi

|uj | = M

(15)

Expanding this equation, we obtain

	T

Œ∂ÃÇ = argmin{L(Œ∂)}

555

(14)

= M 2 Œ£ÃÇ.

(22)

Therefore, the factorization (H)T H = M 2 Œ£ÃÇ is not unique, and
H can be any matrix in the form of Œ©K, so it is impossible to
acquire the exact transformation matrix H through the ellipsoid
fitting, while the combined bias B can be estimated accurately.
In the next section, we will discuss how to determine the transformation matrix by exploring the intrinsic relationships among
the sensor readings.

556

IEEE TRANSACTIONS ON BIOMEDICAL ENGINEERING, VOL. 62, NO. 2, FEBRUARY 2015

C. Estimation of the Transformation Matrix
In the previous section, any two sensor readings gi and gj (i =
1, 2, . . . , J and i = j) are used independently. However, both
indexes i and j indicate the orientations or rotations that the
sensor node is set to therefore, we can also get the rotation
difference Rj i between the ith orientation and jth orientation.
Therefore, we have
ui = H ¬∑ (gi‚àíB )

(23)

uj = H ¬∑ (gj ‚àíB )

(24)

Fig. 1. BSN hardware platform used for this study. (a) BSN sensor node and
its stackable sensor daughter boards. (b) Bespoke housing for the BSN sensor
node.

and

where uj =

Then, uj ‚àí ui can be written as


uj ‚àí ui = Rji ‚àí I3 ui = H(gj ‚àí gi )

and we can then derive the following homogeneous linear leastsquares problem:

Rji ui .

(25)

where I3 is the 3 √ó 3 identity matrix. The above equation can
then be expanded as

‚éß i
Rj ‚àí I3 uxi ‚àí (gj ‚àí gi )H1T = 0
‚é™
‚é®

Rji ‚àí I3 uyi ‚àí (gj ‚àí gi )H2T = 0
(26)
‚é™
 z
‚é© i
Rj ‚àí I3 ui ‚àí (gj ‚àí gi )H3T = 0
where

‚é°

H1

‚é§

‚é•
‚é¢
H = ‚é£ H2 ‚é¶
H3
and ui =

[uxi , uyi , uzi ].

and

Define
T

Aij = Rji ‚àí I3 , Œîij

(27)

T

X = uTi H1 H2 H3

(28)

we can have the matrix representation for (26):
Aij X = 0
where
Œîj i

‚é°
‚é¢
=‚é£

‚àí(gj ‚àí gi )

T

0
0

(29)

0

0

‚àí(gj ‚àí gi )

T

0

0

‚é§
‚é•
‚é¶.

‚àí(gj ‚àí gi )T

However, it is necessary to have at least 12 equations to find
the nonzero solution for X. Since any pair of gi and gj leads to
three equations as shown in (26), at least five sensor readings
are required. Given J >> 5 in the calibration process, we can
define
‚é° i ‚é§
A1
‚é¢ . ‚é•
‚é¢ . ‚é•
‚é¢ . ‚é•
‚é•
‚é¢
‚é¢ Ai ‚é•
‚é¢ i‚àí1 ‚é•
A=‚é¢ i ‚é•
‚é¢ Ai+1 ‚é•
‚é•
‚é¢
‚é¢ . ‚é•
‚é¢ . ‚é•
‚é£ . ‚é¶
AiJ

subject to X = 0.

AX = 0,

(30)

The vector X can be recovered from the singularity value decomposition (SVD)-related techniques [28][29]. The SVD of
the matrix A is calculated as
A = U Œ£V T

(31)

where the columns of U contain the eigenvectors of AAT , the
columns of V contain the eigenvectors of AT A, and the diagonal
of Œ£ indicates the singular values of A. The last column of matrix
V corresponding to the smallest singular value of A, is taken
as the nonzero solution of the vector X. However, if the last
column vector vX is the solution for AX = 0, then Œ∫vX , where
Œ∫ is a arbitrary scale, will also be a solution; therefore, the next
step is to determine the value of Œ∫. According to the definition
of vector X in (28), the vector Œ∫vX can be easily reshaped into
u
H
and the transformation matrix Œ∫vX
.
the magnetic vector Œ∫vX
Since the magnitude of the local magnetic field is M , we can
then have
u
 = M2
Œ∫2 vX

so Œ∫ can be calculated as



Œ∫=¬±

M2
u .
vX

(32)

(33)

Since the sign of Œ∫ will not affect the performance of a magnetometer for orientation estimation in practice, we always chose
the positive Œ∫ in our implementation.
III. SIMULATION AND EXPERIMENTAL RESULTS
In order to evaluate the performance of the proposed magnetometer calibration method, detailed simulation and laboratory
experiments were conducted. The simulation study was based
on Monte Carlo simulation to illustrate the performance of the
proposed calibration method. For the experimental results presented in this paper, we used the body sensor network (BSN)
platform [30], [31] developed by our lab, which consists of
three stackable daughter boards: the sensor board, the main processor board, and the battery board. They are connected via a
stackable connector design as shown in Fig. 1(a). Each BSN
node is equipped with Analog Devices ADXL330 (8 bits ADC
used) [32] for 3-D acceleration measurement, an InvenSense

ZHANG AND YANG: MICROMAGNETOMETER CALIBRATION FOR ACCURATE ORIENTATION ESTIMATION

557

TABLE I
MODEL PARAMETERS USED FOR MAGNETOMETER CALIBRATION
Nonorthogonality
Mounting
Scaling (m g )
Bias
Hard Iron
Soft Iron

Œ± = 0.1
œÜ = 0.1
s x = 1/1.2
b x = 32 000
b xh i = 268
a 1s i1 = 1
a 2s i1 = 0.1
a 3s i1 = 0.1

Œ≤ = 0.1
Œ∏ = 0.1
s y = 1/1.383
b y = 32 000
b yh i = ‚àí123
a 1s i2 = 0.1
a 2s i2 = 1
a 3s i2 = 0.1

Œ≥ = 0.1
œà = 0.1
s z = 1/1.12
b z = 32 000
b zh i = ‚àí109
a 1s i3 = 0.1
a 3s i2 = 0.1
a 3s i3 = 1

ITG-3200 digital gyroscope (12 bits ADC used) [33] for 3-D
angular velocity measurement, and a Honeywell HMC5843 (12
bits ADC used) [34] for 3-D magnetic field measurement. In
order to calibrate the BSN node, a bespoke housing for the BSN
node is designed as shown in Fig. 1(b).
A. Sensor Calibration Simulation Results
In the simulation experiment, we evaluated the estimation
results of the magnetometer sensor model parameters when we
randomly position the sensor in 30 different orientations. A zero
mean Gaussian distributed error with variance 0.1 mg was added
to the voltage readings y to simulate sensor noise. In Table I,
the settings used in the simulation are summarized.
The simulation was repeated for 1000 times, and statistical results for B and H are given in Fig 2. As we can see from Fig 2(a),
over 92% of the estimated combined bias has smaller error than
0.005%. It can also be noted that the maximum estimation error
for the combined bias is 0.012%, which is small and imperceptible. Fig 2(b) shows the error histogram for the nine elements
of the transformation matrix. It is evident that the majority of
the estimated errors are located between 0% and 0.15%. Although the transformation matrix estimation error has a slight
increase over that of the combined bias estimation, it is still
very small and negligible. The SVD described in Section II-C
can not only estimate the transformation matrix, but also provide
the reference magnetic vector, which is given in the Fig. 2(c).
Similarly, the errors of the estimated magnetic vector are also
small (0.05%). In conclusion, the above analysis has shown that
the proposed ellipsoid fitting method can estimate the combined
bias values accurately. By exploring the relationships among raw
sensor readings, it is also possible to determine the transformation matrix without the need of extra devices to measure the
magnetic information in advance.
B. Calibration Results
We then applied the proposed magnetometer calibration
method to our BSN node. The sensor node was rotated to different orientations to evaluate the reproducibility of the proposed
method. To make sure the magnetic distortion and local magnetic field are constant for different orientations, the sensor node
was kept in a small area with ignorable translational movement
when rotating the sensor node. Nine datasets have been acquired
with a sampling frequency of 33 Hz. In each dataset, the sensor
node was randomly placed at 20‚Äì30 different orientations, and

Fig. 2. Statistical results for combined bias B, transformation matrix H ,
and magnetic vector u i over the 1000 simulations, demonstrating the small
estimation errors involved. (a) Combined bias. (b) Transformation matrix. (c)
Magnetic vector.

at least 5 s of data were collected for each orientation. Instead of
using all the raw sensor readings for each orientation, only the
mean value of these readings was used to increase the signalto-noise ratio (SNR) for sensor model parameter determination.
Since the proposed method involves many matrix operations,

558

IEEE TRANSACTIONS ON BIOMEDICAL ENGINEERING, VOL. 62, NO. 2, FEBRUARY 2015

Fig. 3. Calibration results for the BSN sensor node. During the experiments,
the same calibration method was repeated nine times on the same sensor node.
Although there is no ground truth for the combined bias and transformation
matrix, the estimation results have shown good consistency, which illustrates
the robustness of our proposed method. (a) Combined bias. (b) Transformation
Matrix.

all the data were sent back to a PC with 3.40-GHz Intel Core i5
processor and 8G RAM for processing. Once the transformation
matrix H and combined bias B are determined, we can then set
the values of H and B permanently for each BSN node.
The combined bias and the transformation matrix estimation results obtained from these nine independent datasets are
shown in Fig. 3(a) and (b). As we can see from the figures, both
the combined bias and transformation matrix estimation results
are similar for all the trials performed, and the deviations are
small compared to the mean values. The consistency among all
the nine trials indicates the good repeatability of the proposed
method. It is also worth noting that although there is no ground

Fig. 4. Conversion of the 20 randomly chosen raw sensor readings into the
metric unit (gauss) using the nine sets of estimated combined bias and transformation matrix. Small deviations were achieved for all the data points using the
nine sets of the conversion parameters. (a) Converted sensor measurements in
gauss. (b) Mean and standard deviation.

truth for the combined bias and transformation matrix, the consistency of the data illustrates the robustness of our proposed
method.
The main purpose of the magnetometer calibration is to accurately convert the raw sensor readings into physical quantities in
metric unit; we therefore randomly chose 20 raw sensor readings
and then converted them into meaningful quantities in gauss in
our second experiment. Fig. 4(a) shows the converted sensor
measurements using the nine sets of the estimated combined
bias and the transformation matrix. It is evident that for any
sensor readings, all the nine conversions are close to each other,
which again illustrates the effectiveness and robustness of the
proposed calibration method. The quantitative results for these
conversions are provided in the Fig. 4(b). In the figure, the mean
and the standard deviation of the nine conversions for each raw

ZHANG AND YANG: MICROMAGNETOMETER CALIBRATION FOR ACCURATE ORIENTATION ESTIMATION

559

TABLE II
RMS, MEAN, SD, AND CORRELATION COEFFICIENTS OF THE ESTIMATED
ATTITUDE COMPARED TO THE BTS OPTICAL SYSTEM
H+B Calibration

Roll
Pitch
Yaw

Fig. 5. Orientation estimation results in quaternion compared to the BTS
measurements after the magnetometer calibration.

RMS (unit: rad)
(Mean, SD)
0.0397
(0.0014¬± 0.0397)
0.0698
(‚àí0.0431¬±0.0549)
0.0507
(0.0060¬±0.0503)

Correlation
Coefficient
0.9970
0.9930
0.9981

B Calibration only
RMS (unit: rad)
(Mean, SD)
0.0548
(‚àí0.0252¬±0.0487)
0.0854
(‚àí0.0171¬±0.0836)
0.0744
(0.0095¬±0.0738)

Correlation
Coefficient
0.9763
0.9720
0.9873

lying sensor model parameters accurately. Based on the derived
sensor model, the sensor readings can be converted to physical
quantities in metric units for accurate attitude estimation.
IV. CONCLUSION

sensor reading are provided. The maximum standard deviation
is less than 0.01, resulting the variance smaller than 0.0001.
However, for orientation estimation, the variance for the magnetometer measurement is normally set to be larger than 0.01
[35]. This means that the small variations of the different conversions can be taken as the measurement noise, which can
be well modeled by the measurement covariance matrix in the
orientation estimation applications.
C. Attitude Estimation Using Calibrated Sensors
As mentioned earlier, the magnetometer and the inertial sensors are widely used for attitude estimation in biomedical applications. Since the magnetometer is calibrated and aligned to the
inertial sensor axes, we then used these three sensors together
for biomotion analysis. In our experiment, the sensor node was
placed on a human forearm to track its movement. The subject
then rotated the arm arbitrarily and smoothly to make sure there
is no linear acceleration interference or magnetic disturbance.
We then used algorithm presented in [36] to determine the orientation of the arm. Fig. 5 shows the estimated orientation using
the proposed method, and the ground truth measurements from
the optical motion tracking system BTS SMART-D [37] are also
shown in the figure. It is evident that there is significant improvement after taking the transformation matrix into consideration.
Since the gyroscope integration drift cannot be compensated if
only the combined bias was considered, therefore, there were
some errors in the estimated attitude if the transformation matrix was ignored. The quantitative comparison results between
the BTS system and BSN sensor platform are shown in Table II.
From the results derived, it is evident that the proposed method
significantly reduces the root mean square (RMS) errors. There
is also an excellent correlation between the calibrated result with
that of the BTS system.
The above analyses have shown that the proposed magnetometer calibration method can significantly improve the attitude estimation accuracy for biomotion analysis applications.
This suggests that the calibration method can recover the under-

In this paper, a two-step approach has been presented to tackle
all the parameters involved in the sensor errors, magnetic errors,
and also the alignment difference between the magnetometer
and the inertial sensor axes. The summation of the offset and
hard iron error was taken as a combined bias, while all the other
errors were combined together as the transformation matrix.
In our method, the combined bias was determined by elliptical fitting. The relationship of the raw sensor readings was then
explored to extract the transformation matrix. Singular value decomposition was then applied to estimate both the transformation matrix and the magnetic vector. Detailed validation results
demonstrate the effectiveness of the proposed sensor calibration
method.
It should be noted that for the current method, it does not take
temperature related drift into consideration. Although this can be
addressed by periodic recalibration, it may present difficulties
for practical applications. Further work is therefore required
for continuous self-calibration with consideration of different
temporal characteristics of the sensors combined with the use of
temperature-controlled casing designs to minimize these errors.
REFERENCES
[1] Z.-Q. Zhang, and J.-K. Wu, ‚ÄúA novel hierarchical information fusion
method for three-dimensional upper limb motion estimation,‚Äù IEEE Trans.
Instrum. Meas., vol. 60, no. 11, pp. 3709‚Äì3719, Nov. 2011.
[2] Z. Zhang, A. Panousopoulou, and G.-Z. Yang, ‚ÄúWearable sensor integration and bio-motion capture: A practical perspective,‚Äù in Body Sensor
Networks. New York, NY, USA: Springer, 2014, pp. 495‚Äì526.
[3] S. Huang, C. Luo, S. Ye, F. Liu, B. Xie, C. Wang, L. Yang, Z. Huang, and
J. Wu, ‚ÄúMotor impairment evaluation for upper limb in stroke patients on
the basis of a microsensor,‚Äù in Proc. Int. J. Rehabil. Res., vol. 35, no. 2,
pp. 161‚Äì169, 2012.
[4] B. H. Koning, M. M. van der Krogt, C. T. Baten, and B. F. Koopman,
‚ÄúDriving a musculoskeletal model with inertial and magnetic measurement
units,‚Äù Comput. Methods in Biomech. Biomed. Eng., pp. 1‚Äì11, 2013.
[5] W. Xu, M. Zhang, A. A. Sawchuk, and M. Sarrafzadeh, ‚ÄúRobust human activity and sensor location corecognition via sparse signal representation,‚Äù IEEE Trans. Biomed. Eng., vol. 59, no. 11, pp. 3169‚Äì3176,
Nov. 2012.
[6] O. D. Lara and M. A. Labrador, ‚ÄúA survey on human activity recognition
using wearable sensors,‚Äù IEEE Commun. Surveys Tuts., vol. 15, no. 3,
pp. 1192‚Äì1209, Oct.-Dec. 2013.

560

IEEE TRANSACTIONS ON BIOMEDICAL ENGINEERING, VOL. 62, NO. 2, FEBRUARY 2015

[7] A. Salarian, P. R. Burkhard, F. J. Vingerhoets, B. M. Jolles, and K.
Aminian, ‚ÄúA novel approach to reducing number of sensing units for
wearable gait analysis systems,‚Äù IEEE Trans. Biomed. Eng., vol. 60,
no. 1, pp. 72‚Äì77, Jan. 2013.
[8] X. Meng, Z.-Q. Zhang, J.-K. Wu, W.-C. Wong, and H. Yu, ‚ÄúSelf-contained
pedestrian tracking during normal walking using an inertial/magnetic sensor module,‚Äù IEEE Trans. Biomed. Eng., vol. 61, no. 3, pp. 892‚Äì899,
Mar. 2014.
[9] A. M. Sabatini, ‚ÄúQuaternion-based extended kalman filter for determining
orientation by inertial and magnetic sensing,‚Äù IEEE Trans. Biomed. Eng.,
vol. 53, no. 7, pp. 1346‚Äì1356, Jul. 2006.
[10] Z.-Q. Zhang, L.-Y. Ji, Z.-P. Huang, and J. Wu, ‚ÄúAdaptive information
fusion for human upper limb movement estimation,‚Äù IEEE Trans. Syst.,
Man Cybern., A, Syst. Humans, vol. 42, no. 5, pp. 1100‚Äì1108, Sep. 2012.
[11] S. Bonnet, C. Bassompierre, C. Godin, S. Lesecq, and A. Barraud, ‚ÄúCalibration methods for inertial and magnetic sensors,‚Äù Sens. Actuators A,
Phys., vol. 156, no. 2, pp. 302‚Äì311, 2009.
[12] M. Kok, J. D. Hol, T. Schon, F. Gustafsson, and H. Luinge, ‚ÄúCalibration
of a magnetometer in combination with inertial sensors,‚Äù in Proc. 15th Int.
Conf. Inf. Fusion, 2012, pp. 787‚Äì793.
[13] B. Gambhir, ‚ÄúDetermination of magnetometer biases using module
residg,‚Äù Comput. Sci. Corp., Falls Church, VA, USA, Tech. Rep. 300032700, 1975.
[14] R. Alonso and M. D. Shuster, ‚ÄúTwostep: A fast robust algorithm for
attitude-independent magnetometer-bias determination,‚Äù J. Astronaut.
Sci., vol. 50, no. 4, pp. 433‚Äì452, 2002.
[15] R. Alonso and M.-D. Shuster, ‚ÄúComplete linear attitude-independent magnetometer calibration,‚Äù J. Astronaut. Sci., vol. 50, no. 4, pp. 477‚Äì490,
2002.
[16] G. H. Elkaim and C. C. Foster, ‚ÄúMetasensor: Development of a low-cost,
high quality attitude heading reference system,‚Äù in Proc. ION GNSS Meet.,
Fort Worth, TX, USA, 2006, pp. 1124‚Äì1135.
[17] D. Gebre-Egziabher, G. Elkaim, P. David, and B. Parkinson, ‚ÄúCalibration
of strapdown magnetometers in magnetic field domain,‚Äù J. Aerosp. Eng.,
vol. 19, no. 2, pp. 87‚Äì102, 2006.
[18] V. Renaudin, M. H. Afzal, and G. Lachapelle, ‚ÄúComplete triaxis magnetometer calibration in the magnetic domain,‚Äù J. Sens., vol. 2010, art. no.
967245, (10 pp.), 2010.
[19] J. Vasconcelos, G. Elkaim, C. Silvestre, P. Oliveira, and B. Cardeira,
‚ÄúGeometric approach to strapdown magnetometer calibration in sensor
frame,‚Äù IEEE Trans. Aerosp. Electron. Syst., vol. 47, no. 2, pp. 1293‚Äì
1306, Apr. 2011.
[20] Z. Wu, Y. Wu, X. Hu, and M. Wu, ‚ÄúCalibration of three-axis magnetometer using stretching particle swarm optimization algorithm,‚Äù IEEE Trans.
Instrum. Meas., vol. 62, no. 2, pp. 281‚Äì292, Feb. 2013.
[21] J. C. Springmann and J. W. Cutler, ‚ÄúAttitude-independent magnetometer calibration with time-varying bias,‚Äù J. Guid., Control, Dyn., vol. 35,
no. 4, pp. 1080‚Äì1088, 2012.
[22] H. Pang, Q. Zhang, W. Wang, J. Wang, J. Li, S. Luo, C. Wan, D. Chen,
M. Pan, and F. Luo, ‚ÄúCalibration of three-axis magnetometers with differential evolution algorithm,‚Äù J. Magn. Magn. Mater., vol. 346, pp. 5‚Äì10,
2013.
[23] M. Kok and T. Schon, ‚ÄúMaximum likelihood calibration of a magnetometer using inertial sensors,‚Äù in Proc. 19th World Congr. Int. Fed. Autom.
Control, pp. 1‚Äì6, 2014.
[24] Z.-Q. Zhang and G.-Z. Yang, ‚ÄúCalibration of miniature inertial and magnetic sensor units for robust attitude estimation,‚Äù IEEE Trans. Instrum.
Meas., vol. 63, no. 3, pp. 711‚Äì718, Mar. 2014.
[25] A. Fitzgibbon, M. Pilu, and R. Fisher, ‚ÄúDirect least square fitting
of ellipses,‚Äù IEEE Trans. Pattern Anal. Mach. Intell., vol. 21, no. 5,
pp. 476‚Äì480, May 1999.
[26] I. Markovsky, A. Kukush, and S. Huffel, ‚ÄúConsistent least squares fitting
of ellipsoids,‚Äù Numerische Mathematik, vol. 98, no. 1, pp. 177‚Äì194, 2004.
[27] N. Chernov and H. Ma, ‚ÄúLeast squares fitting of quadratic curves and
surfaces,‚Äù in Computer Vision, Hauppauge, NY, USA: Nova Science, 2011,
Ch. 7, pp. 285‚Äì302.
[28] A. Yeredor and B. De Moor, ‚ÄúOn homogeneous least-squares problems
and the inconsistency introduced by mis-constraining,‚Äù Comput. Statist.
Data Anal., vol. 47, no. 3, pp. 455‚Äì465, 2004.
[29] K. InkilaÃà, ‚ÄúHomogeneous least squares problem,‚Äù Photogrammetric J.
Finland, vol. 19, no. 2, pp. 34‚Äì42, 2005.
[30] Z.-Q. Zhang, J. Pansiot, B. Lo, and G.-Z. Yang, ‚ÄúHuman back movement
analysis using bsn,‚Äù in Proc. Int. Conf. Body Sens. Netw., 2011, pp. 13‚Äì18.
[31] B. Lo and G. Yang, ‚ÄúKey technical challenges and current implementations
of body sensor network,‚Äù in Proc. 2nd Int. Workshop Body Sens. Netw.,
pp. 1‚Äì5, 2005.

[32] Analog Devices ADXL330. (2011). [Online]. Available: http://www.
analog.com/en/sensors/inertial-sensors/adxl330/products/product.html
[33] Invensense ITG-3200. (2011). [Online]. Available: http://invensense.com/
mems/gyro/itg3200.html
[34] Honeywell HMC5483. (2011). [Online]. Available: www.
magneticsensors.com/datasheets/HMC5843.pdf
[35] Z. Zhang, W. Wong, and J. Wu, ‚ÄúUbiquitous human upper-limb motion
estimation using wearable sensors,‚Äù IEEE Trans. Inf. Technol. Biomed.,
vol. 15, no. 4, pp. 513‚Äì521, Jul. 2011.
[36] Z. Zhang, X. Meng, and J. Wu, ‚ÄúQuaternion-based Kalman filter with
vector selection for accurate orientation tracking,‚Äù IEEE Trans. Instrum.
Meas., vol. 61, no. 10, pp. 2817‚Äì2824, Oct. 2012.
[37] BTSBioengineering. (2013). [Online]. Available: http://www.
btsbioengineering.com/

Zhi-Qiang Zhang received the B.E. degree in computer science and technology from the School of Electrical Information and Engineering, Tianjian University, Tianjian, China, in 2005, and the Ph.D. degree
from the Sensor Network and Application Research
Center, Graduate University, Chinese Academy of
Sciences, Beijing, China, in 2010.
He is currently a Research Associate with the
Hamlyn Centre for Robotic Surgery, Imperial College, London, U.K. His research interests include
body sensor network, information fusion, machine
learning, and targets tracking.

Guang-Zhong Yang (S‚Äô90‚ÄìM‚Äô91‚ÄìSM‚Äô08‚ÄìF‚Äô11) received the Ph.D. degree in computer science from
Imperial College London, London, U.K., in 1991. He
is the Director and Cofounder of the Hamlyn Centre
for Robotic Surgery, Imperial College, London, U.K.,
Deputy Chairman of the Institute of Global Health
Innovation, Imperial College. He also holds a number of key academic positions at Imperial College:
he is the Director and Founder of the Royal Society/Wolfson Medical Image Computing Laboratory,
Cofounder of the Wolfson Surgical Technology Laboratory, and Chairman of the Centre for Pervasive Sensing. His main research interests include medical imaging, sensing, and robotics. In imaging, he is credited
for a number of novel MR phase contrast velocity imaging and computational
modeling techniques that have transformed in vivo blood flow quantification
and visualization. These include the development of locally focused imaging
combined with real-time navigator echoes for resolving respiratory motion for
high-resolution coronary-angiography, as well as MR dynamic flow pressure
mapping for which he received the ISMRM I. I Rabi Award. He pioneered the
concept of perceptual docking for robotic control, which represents a paradigm
shift of learning and knowledge acquisition of motor and perceptual/cognitive
behavior for robotics, as well as the field of body sensor network for providing personalized wireless monitoring platforms that are pervasive, intelligent,
and context-aware. The Hamlyn Centre directed by him has been established
for developing safe, effective, and accessible imaging, sensing and robotics
technologies that can reshape the future of healthcare for both developing and
developed countries. Focusing on technological innovation but with a strong
emphasis on clinical translation and direct patient benefit with a global impact,
the centre is at the forefront of research in imaging, sensing and robotics for
addressing global health challenges associated with demographic, environment,
social and economic changes. The centre plays an active role in international
collaboration and outreach activities, as well as in the training of surgeons and
engineers in medical imaging, sensing and robotics, thereby facilitating a fully
integrated clinical approach.
Mr. Yang is a Distinguished Lecturer for IEEE Engineering in Medicine and
Biology Society. He is a Fellow of the Royal Academy of Engineering, Fellow
of The Institution of Engineering and Technology, The American Institute for
Medical and Biological Engineering, The International Academy of Medical
and biological Engineering, Society of Medical Imaging and Computer Assisted Intervention, City and Guilds of London. He received the Royal Society
Research Merit Award and The Times Eureka ‚ÄúTop 100‚Äù in British Science.

